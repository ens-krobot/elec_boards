<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Carte capteurs: Référence du fichier usb_device.c</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Généré par Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Page&nbsp;principale</span></a></li>
      <li><a href="pages.html"><span>Pages&nbsp;associées</span></a></li>
      <li><a href="classes.html"><span>Structures&nbsp;de&nbsp;données</span></a></li>
      <li class="current"><a href="files.html"><span>Fichiers</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>Référence du fichier usb_device.c</h1><code>#include &quot;<a class="el" href="_generic_type_defs_8h.html">GenericTypeDefs.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="_compiler_8h.html">Compiler.h</a>&quot;</code><br>
<code>#include &quot;./USB/usb_ch9.h&quot;</code><br>
<code>#include &quot;./USB/USB.h&quot;</code><br>
<code>#include &quot;./USB/usb_device.h&quot;</code><br>
<code>#include &quot;<a class="el" href="_hardware_profile_8h.html">HardwareProfile.h</a>&quot;</code><br>
<code>#include &quot;<a class="el" href="usb__config_8h.html">usb_config.h</a>&quot;</code><br>

<p>
<div class="dynheader">
Graphe des dépendances par inclusion de usb_device.c:</div>
<div class="dynsection">
<p><center><img src="usb__device_8c__incl.png" border="0" usemap="#usb_device.c_map" alt=""></center>
<map name="usb_device.c_map">
<area shape="rect" href="_generic_type_defs_8h.html" title="GenericTypeDefs.h" alt="" coords="5,83,168,112"><area shape="rect" href="_compiler_8h.html" title="Compiler.h" alt="" coords="192,83,291,112"><area shape="rect" href="_hardware_profile_8h.html" title="Définitions spécifiques au PIC utilisé, pour l&#39;USB et les LEDs notamment." alt="" coords="811,83,963,112"><area shape="rect" href="usb__config_8h.html" title="usb_config.h" alt="" coords="987,83,1101,112"></map>
</div>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
<tr><td colspan="2"><br><h2>Fonctions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile <a class="el" href="union_____b_d_t.html">BDT_ENTRY</a> <a class="el" href="usb__device_8h.html#32640ece9cd65c03e939a98578f7232b">BDT</a>[(USB_MAX_EP_NUMBER+1)*2]&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#7b09f2a575a25b553155ad04e7a96f99">__attribute__</a> ((aligned(512)))</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">USB FIXED LOCATION VARIABLES.  <a href="#7b09f2a575a25b553155ad04e7a96f99"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#16da2c36e4eb6a018808f99f291433ca">USBDeviceInit</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">DECLARATIONS.  <a href="#16da2c36e4eb6a018808f99f291433ca"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#f35807553af66eab5b5d459fa13b274e">USBDeviceTasks</a> (void)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">PUBLIC PROTOTYPES.  <a href="#f35807553af66eab5b5d459fa13b274e"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#f7fca92a339183ae8f268bb8c3ca4e7e">USBStallHandler</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#1e0966febda8e01d2e4e58ceb42dd46a">USBSuspend</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#9104bea8c7f5045558f6cc5721e7455f">USBWakeFromSuspend</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#e5d35bef641e59de9a7279d639cc10b6">USBCtrlEPService</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#4fd82120d0ce7ac5df27574b2fcd2b8f">USBCtrlTrfSetupHandler</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#d30a9aeba644af617b04c45333fc5125">USBCtrlTrfOutHandler</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#8bfda535b2c9273a24983c1799f3fb42">USBCtrlTrfInHandler</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#5fff309db0c489c108b02e5b0c665f3a">USBPrepareForNextSetupTrf</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#6d12a2e760ab2e6dc50498a76e3cfcc4">USBCheckStdRequest</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#109b75c6ceba7a1ac93ac8653dae6405">USBStdFeatureReqHandler</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#05d1ee4a1e4a8c8af6fb4816eba0a591">USBStdGetDscHandler</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#07599ba7765be64baabac4e86cdb5358">USBStdGetStatusHandler</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#0913bb6b0a880a6e29d58c88c3c1e730">USBCtrlEPServiceComplete</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#6dde221e5c27eb18f62335810c830630">USBCtrlTrfTxService</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#8cc0ab9c4555c92370fe9d0ffb0685c7">USBCtrlTrfRxService</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#23b85d487e9d3b37a4580138baf6b097">USBStdSetCfgHandler</a> (void)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#1901fa27385226b6cdad1f5b091e5374">USBConfigureEndpoint</a> (<a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> EPNum, <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> direction)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#25c6b82e249f563f00732a7e242c4267">USBEnableEndpoint</a> (<a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> ep, <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> options)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#9c20d0ce9a00250250ff518d2705a5e1">USBStallEndpoint</a> (<a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> ep, <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> dir)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_HANDLE&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#a7a7d33cf7a6033e1d158538375e2be8">USBTransferOnePacket</a> (<a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> ep, <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> dir, <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *data, <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> len)</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a> (<a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *reg, <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> flag)</td></tr>

<tr><td colspan="2"><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#86a182d8ae8787e02cfe4c80ad4a612c">USBDeviceState</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">INCLUDES.  <a href="#86a182d8ae8787e02cfe4c80ad4a612c"></a><br></td></tr>
<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#24f71d425c4a6effac1a2d705afe5449">USBActiveConfiguration</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#ddb2a0fc77382ce058ef62d88874cf8e">USBAlternateInterface</a> [USB_MAX_NUM_INT]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile <a class="el" href="union_____b_d_t.html">BDT_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile <a class="el" href="union_____b_d_t.html">BDT_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile <a class="el" href="union_____b_d_t.html">BDT_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#9777e7690b52368e534894b7c6c2bb18">pBDTEntryOut</a> [USB_MAX_EP_NUMBER+1]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile <a class="el" href="union_____b_d_t.html">BDT_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a> [USB_MAX_EP_NUMBER+1]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#75b7cb53340c80ab6788fe4dc9ad5d48">shortPacketStatus</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#98752e9a61499b8a4998c0c3437cf73e">controlTransferState</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="usb__device_8h.html#c2a1cb280e92f3dd552c9af14a0cbdad">IN_PIPE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a> [1]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="usb__device_8h.html#4ba5b650d99f2b27b570efced4104d57">OUT_PIPE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a> [1]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#f268ebc32589a7de7b47922e44b97a55">pDst</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#54d65c7fa62e62c9754371e42f5111b9">BOOL</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#eada8d244f77e59054a0e399fc5e87cb">RemoteWakeup</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#b75c628c73eaac9e28acbff83a909e63">USTATcopy</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#2b0e863dadf920709ec53d9088ee7c91">WORD</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#77767bab7373fcc3bb2c90b05189e0dd">USBInMaxPacketSize</a> [USB_MAX_EP_NUMBER]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#737da50d271f9f7d021abbb7a3a67f6c">USBInData</a> [USB_MAX_EP_NUMBER]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile <a class="el" href="usb__device_8h.html#15cc7fbb1fa621148405d99bcd66092b">CTRL_TRF_SETUP</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a></td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a> [USB_EP0_BUFF_SIZE]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#9505d96e11714db930d011558c1037f9">hid_report_out</a> [HID_INT_OUT_EP_SIZE]</td></tr>

<tr><td class="memItemLeft" nowrap align="right" valign="top">volatile unsigned char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="usb__device_8c.html#faadca393a7d0eb149a153021e5b285b">hid_report_in</a> [HID_INT_IN_EP_SIZE]</td></tr>

</table>
<hr><h2>Documentation des fonctions</h2>
<a class="anchor" name="7b09f2a575a25b553155ad04e7a96f99"></a><!-- doxytag: member="usb_device.c::__attribute__" ref="7b09f2a575a25b553155ad04e7a96f99" args="((aligned(512)))" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile <a class="el" href="union_____b_d_t.html">BDT_ENTRY</a> <a class="el" href="usb__device_8h.html#32640ece9cd65c03e939a98578f7232b">BDT</a> [(USB_MAX_EP_NUMBER + 1) * 2] __attribute__           </td>
          <td>(</td>
          <td class="paramtype">(aligned(512))&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
USB FIXED LOCATION VARIABLES. 
<p>

</div>
</div><p>
<a class="anchor" name="6d12a2e760ab2e6dc50498a76e3cfcc4"></a><!-- doxytag: member="usb_device.c::USBCheckStdRequest" ref="6d12a2e760ab2e6dc50498a76e3cfcc4" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBCheckStdRequest           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01104"></a>01104 {
<a name="l01105"></a>01105     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.RequestType != <a class="code" href="usb__device_8h.html#0b8ca8ad62b88c01b639bad62eafcbf1">STANDARD</a>) <span class="keywordflow">return</span>;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107     <span class="keywordflow">switch</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bRequest)
<a name="l01108"></a>01108     {
<a name="l01109"></a>01109         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#8a4cf0ab446cd30b277c537bd9a0bc35">SET_ADR</a>:
<a name="l01110"></a>01110             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;            <span class="comment">// This will generate a zero length packet</span>
<a name="l01111"></a>01111             <a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> = <a class="code" href="usb__device_8h.html#5e40c9d99b9b05d5a6c622afedf21f6b">ADR_PENDING_STATE</a>;       <span class="comment">// Update state only</span>
<a name="l01112"></a>01112             <span class="comment">/* See USBCtrlTrfInHandler() for the next step */</span>
<a name="l01113"></a>01113             <span class="keywordflow">break</span>;
<a name="l01114"></a>01114         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#24e3cca701a91e33a03e010006dac5ab">GET_DSC</a>:
<a name="l01115"></a>01115             <a class="code" href="usb__device_8h.html#05d1ee4a1e4a8c8af6fb4816eba0a591">USBStdGetDscHandler</a>();
<a name="l01116"></a>01116             <span class="keywordflow">break</span>;
<a name="l01117"></a>01117         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#5f3afe7f1443913fd4786875f70d4f6c">SET_CFG</a>:
<a name="l01118"></a>01118             <a class="code" href="usb__device_8h.html#23b85d487e9d3b37a4580138baf6b097">USBStdSetCfgHandler</a>();
<a name="l01119"></a>01119             <span class="keywordflow">break</span>;
<a name="l01120"></a>01120         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#067cca3b3f06d1d93fa4159b943aea1d">GET_CFG</a>:
<a name="l01121"></a>01121             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRam = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;<a class="code" href="usb__device_8h.html#91adced4a63e99db6b4b72faa09e78c5">USBActiveConfiguration</a>;         <span class="comment">// Set Source</span>
<a name="l01122"></a>01122             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.ctrl_trf_mem = <a class="code" href="usb__device_8h.html#835b0195046543ba63b1ca0928077ce6">_RAM</a>;               <span class="comment">// Set memory type</span>
<a name="l01123"></a>01123             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.v[0] = 1;                         <span class="comment">// Set data count</span>
<a name="l01124"></a>01124             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;
<a name="l01125"></a>01125             <span class="keywordflow">break</span>;
<a name="l01126"></a>01126         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#eba76c92af8f1a94982ec4cb767452f0">GET_STATUS</a>:
<a name="l01127"></a>01127             <a class="code" href="usb__device_8h.html#07599ba7765be64baabac4e86cdb5358">USBStdGetStatusHandler</a>();
<a name="l01128"></a>01128             <span class="keywordflow">break</span>;
<a name="l01129"></a>01129         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#15663e06305bdc7c63e8fbb3e870a034">CLR_FEATURE</a>:
<a name="l01130"></a>01130         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#f8b97e67097fbf7d56c3dcac52fe679e">SET_FEATURE</a>:
<a name="l01131"></a>01131             <a class="code" href="usb__device_8h.html#109b75c6ceba7a1ac93ac8653dae6405">USBStdFeatureReqHandler</a>();
<a name="l01132"></a>01132             <span class="keywordflow">break</span>;
<a name="l01133"></a>01133         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#f4f418884d0df62d4c2696b7c3b1756c">GET_INTF</a>:
<a name="l01134"></a>01134             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRam = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;<a class="code" href="usb__device_8c.html#ddb2a0fc77382ce058ef62d88874cf8e">USBAlternateInterface</a>+<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bIntfID;  <span class="comment">// Set source</span>
<a name="l01135"></a>01135             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.ctrl_trf_mem = <a class="code" href="usb__device_8h.html#835b0195046543ba63b1ca0928077ce6">_RAM</a>;               <span class="comment">// Set memory type</span>
<a name="l01136"></a>01136             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.v[0] = 1;                         <span class="comment">// Set data count</span>
<a name="l01137"></a>01137             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;
<a name="l01138"></a>01138             <span class="keywordflow">break</span>;
<a name="l01139"></a>01139         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#ebd60aaf14a50d20e63646caa3d5f186">SET_INTF</a>:
<a name="l01140"></a>01140             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;
<a name="l01141"></a>01141             <a class="code" href="usb__device_8c.html#ddb2a0fc77382ce058ef62d88874cf8e">USBAlternateInterface</a>[<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bIntfID] = <a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bAltID;
<a name="l01142"></a>01142             <span class="keywordflow">break</span>;
<a name="l01143"></a>01143         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#24edb3743fedc624b3eb2b961128ad9b">SET_DSC</a>:
<a name="l01144"></a>01144             <a class="code" href="usb__device_8h.html#85c176c4ca674eb30b43b414f6a66260" title="The USBCBStdSetDscHandler() callback function is called when a SETUP, bRequest: SET_DESCRIPTOR...">USBCBStdSetDscHandler</a>();
<a name="l01145"></a>01145             <span class="keywordflow">break</span>;
<a name="l01146"></a>01146         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#43c627a14ff41632fa9c234a3df41b2b">SYNCH_FRAME</a>:
<a name="l01147"></a>01147         <span class="keywordflow">default</span>:
<a name="l01148"></a>01148             <span class="keywordflow">break</span>;
<a name="l01149"></a>01149     }<span class="comment">//end switch</span>
<a name="l01150"></a>01150 }<span class="comment">//end USBCheckStdRequest</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_6d12a2e760ab2e6dc50498a76e3cfcc4_cgraph.png" border="0" usemap="#usb__device_8c_6d12a2e760ab2e6dc50498a76e3cfcc4_cgraph_map" alt=""></center>
<map name="usb__device_8c_6d12a2e760ab2e6dc50498a76e3cfcc4_cgraph_map">
<area shape="rect" href="usb__device_8h.html#85c176c4ca674eb30b43b414f6a66260" title="The USBCBStdSetDscHandler() callback function is called when a SETUP, bRequest: SET_DESCRIPTOR..." alt="" coords="243,112,453,141"><area shape="rect" href="usb__device_8h.html#109b75c6ceba7a1ac93ac8653dae6405" title="USBStdFeatureReqHandler" alt="" coords="239,165,457,195"><area shape="rect" href="usb__device_8h.html#05d1ee4a1e4a8c8af6fb4816eba0a591" title="USBStdGetDscHandler" alt="" coords="255,219,441,248"><area shape="rect" href="usb__device_8h.html#07599ba7765be64baabac4e86cdb5358" title="USBStdGetStatusHandler" alt="" coords="247,272,449,301"><area shape="rect" href="usb__device_8h.html#23b85d487e9d3b37a4580138baf6b097" title="USBStdSetCfgHandler" alt="" coords="256,325,440,355"><area shape="rect" href="usb__otg_8h.html#df4bb848d4c77a2b5542dd3478bafa76" title="USBOTGDisableAltHnp" alt="" coords="528,5,715,35"><area shape="rect" href="usb__otg_8h.html#d078cd43132c6251de3865b19b8de4cb" title="USBOTGDisableHnp" alt="" coords="536,59,707,88"><area shape="rect" href="usb__otg_8h.html#6ea42b055d88fc42421bd7cb9c120a4a" title="USBOTGDisableSupportHnp" alt="" coords="508,112,735,141"><area shape="rect" href="usb__otg_8h.html#a79b51ab15ce5d80d5e4e78298c9d4c6" title="USBOTGEnableAltHnp" alt="" coords="529,165,713,195"><area shape="rect" href="usb__otg_8h.html#4055c7be50b72d3312c60ccce3464782" title="USBOTGEnableHnp" alt="" coords="539,219,704,248"><area shape="rect" href="usb__otg_8h.html#37a367b19b4b2f62c2dc0064f61d13fb" title="USBOTGEnableSupportHnp" alt="" coords="509,272,733,301"><area shape="rect" href="usb__device_8h.html#e69da16b1f966a62cdd1831df5561cbf" title="This function is called when the device becomes initialized, which occurs after the..." alt="" coords="561,325,681,355"><area shape="rect" href="usb__device_8h.html#25c6b82e249f563f00732a7e242c4267" title="USBEnableEndpoint" alt="" coords="784,325,952,355"><area shape="rect" href="usb__device_8h.html#1901fa27385226b6cdad1f5b091e5374" title="USBConfigureEndpoint" alt="" coords="1001,325,1191,355"></map>
</div>

</div>
</div><p>
<a class="anchor" name="42d85f637ff9d3615ca3090303008adc"></a><!-- doxytag: member="usb_device.c::USBClearInterruptFlag" ref="42d85f637ff9d3615ca3090303008adc" args="(BYTE *reg, BYTE flag)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBClearInterruptFlag           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *&nbsp;</td>
          <td class="paramname"> <em>reg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td>
          <td class="paramname"> <em>flag</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l02063"></a>02063 {
<a name="l02064"></a>02064 <span class="preprocessor">    #if defined(__18CXX)</span>
<a name="l02065"></a>02065 <span class="preprocessor"></span>        *reg &amp;= ~(0x01&lt;&lt;flag);
<a name="l02066"></a>02066 <span class="preprocessor">    #elif defined(__C30__) || defined(__C32__)</span>
<a name="l02067"></a>02067 <span class="preprocessor"></span>        *reg = (0x01&lt;&lt;flag); 
<a name="l02068"></a>02068 <span class="preprocessor">    #else</span>
<a name="l02069"></a>02069 <span class="preprocessor"></span><span class="preprocessor">        #error "Function not defined for this compiler       </span>
<a name="l02070"></a>02070 <span class="preprocessor"></span><span class="preprocessor">    #endif</span>
<a name="l02071"></a>02071 <span class="preprocessor"></span>}
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="1901fa27385226b6cdad1f5b091e5374"></a><!-- doxytag: member="usb_device.c::USBConfigureEndpoint" ref="1901fa27385226b6cdad1f5b091e5374" args="(BYTE EPNum, BYTE direction)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBConfigureEndpoint           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td>
          <td class="paramname"> <em>EPNum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td>
          <td class="paramname"> <em>direction</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01813"></a>01813 {
<a name="l01814"></a>01814     <span class="keyword">volatile</span> <a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>* handle;
<a name="l01815"></a>01815 
<a name="l01816"></a>01816     handle = (<span class="keyword">volatile</span> <a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)&amp;BDT[<a class="code" href="usb__device_8h.html#6f1d734edb188a0d6d7bdfc1501e683c">EP0_OUT_EVEN</a>];
<a name="l01817"></a>01817     handle += <a class="code" href="usb__device_8h.html#deaa1c6f8fd83a66adeca3b9ff28616a">BD</a>(EPNum,direction,0)/<span class="keyword">sizeof</span>(<a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>);
<a name="l01818"></a>01818 
<a name="l01819"></a>01819     handle-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#e624ce5bfa8abc3e45197f13a3df1dba">UOWN</a> = 0;
<a name="l01820"></a>01820 
<a name="l01821"></a>01821     <span class="keywordflow">if</span>(direction == 0)
<a name="l01822"></a>01822     {
<a name="l01823"></a>01823         <a class="code" href="usb__device_8c.html#9777e7690b52368e534894b7c6c2bb18">pBDTEntryOut</a>[EPNum] = handle;
<a name="l01824"></a>01824     }
<a name="l01825"></a>01825     <span class="keywordflow">else</span>
<a name="l01826"></a>01826     {
<a name="l01827"></a>01827         <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[EPNum] = handle;
<a name="l01828"></a>01828     }
<a name="l01829"></a>01829 
<a name="l01830"></a>01830 <span class="preprocessor">    #if (USB_PING_PONG_MODE == USB_PING_PONG__FULL_PING_PONG)</span>
<a name="l01831"></a>01831 <span class="preprocessor"></span>        handle-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#03a5d0d1ead08aa73f8e6b2e519cb8ea">DTS</a> = 0;
<a name="l01832"></a>01832         (handle+1)-&gt;STAT.DTS = 1;
<a name="l01833"></a>01833     #elif (<a class="code" href="usb__config_8h.html#e344e745ba148e0bddd1e7897ffb2170">USB_PING_PONG_MODE</a> == <a class="code" href="usb__hal__pic18_8h.html#6cd509254f5552a826ba03007e1471a0">USB_PING_PONG__NO_PING_PONG</a>)
<a name="l01834"></a>01834         <span class="comment">//Set DTS to one because the first thing we will do</span>
<a name="l01835"></a>01835         <span class="comment">//when transmitting is toggle the bit</span>
<a name="l01836"></a>01836         handle-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#03a5d0d1ead08aa73f8e6b2e519cb8ea">DTS</a> = 1;
<a name="l01837"></a>01837 <span class="preprocessor">    #elif (USB_PING_PONG_MODE == USB_PING_PONG__EP0_OUT_ONLY)</span>
<a name="l01838"></a>01838 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(EPNum != 0)
<a name="l01839"></a>01839         {
<a name="l01840"></a>01840             handle-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#03a5d0d1ead08aa73f8e6b2e519cb8ea">DTS</a> = 1;
<a name="l01841"></a>01841         }
<a name="l01842"></a>01842 <span class="preprocessor">    #elif (USB_PING_PONG_MODE == USB_PING_PONG__ALL_BUT_EP0)    </span>
<a name="l01843"></a>01843 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(EPNum != 0)
<a name="l01844"></a>01844         {
<a name="l01845"></a>01845             handle-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#03a5d0d1ead08aa73f8e6b2e519cb8ea">DTS</a> = 0;
<a name="l01846"></a>01846             (handle+1)-&gt;STAT.DTS = 1;
<a name="l01847"></a>01847         }
<a name="l01848"></a>01848 <span class="preprocessor">    #endif</span>
<a name="l01849"></a>01849 <span class="preprocessor"></span>}
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="e5d35bef641e59de9a7279d639cc10b6"></a><!-- doxytag: member="usb_device.c::USBCtrlEPService" ref="e5d35bef641e59de9a7279d639cc10b6" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBCtrlEPService           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l00754"></a>00754 {
<a name="l00755"></a>00755         <span class="comment">//If the last packet was a EP0 OUT packet</span>
<a name="l00756"></a>00756     <span class="keywordflow">if</span>((<a class="code" href="usb__device_8c.html#b75c628c73eaac9e28acbff83a909e63">USTATcopy</a> &amp; <a class="code" href="usb__hal__pic18_8h.html#38d7c502464d904722c2a4c9f3ad099c">USTAT_EP0_PP_MASK</a>) == <a class="code" href="usb__hal__pic18_8h.html#7626bb56c74a07d55f013e85d47bc027">USTAT_EP0_OUT_EVEN</a>)
<a name="l00757"></a>00757     {
<a name="l00758"></a>00758                 <span class="comment">//Point to the EP0 OUT buffer of the buffer that arrived</span>
<a name="l00759"></a>00759 <span class="preprocessor">        #if defined(__18CXX)</span>
<a name="l00760"></a>00760 <span class="preprocessor"></span>            <a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a> = (<span class="keyword">volatile</span> <a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)&amp;BDT[(<a class="code" href="usb__device_8c.html#b75c628c73eaac9e28acbff83a909e63">USTATcopy</a> &amp; <a class="code" href="usb__hal__pic18_8h.html#db7a31fa07b668d3dfb69a5688913aa5">USTAT_EP_MASK</a>)&gt;&gt;1];
<a name="l00761"></a>00761 <span class="preprocessor">        #elif defined(__C30__) || defined(__C32__)</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span>            <a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a> = (<span class="keyword">volatile</span> <a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)&amp;BDT[(<a class="code" href="usb__device_8c.html#b75c628c73eaac9e28acbff83a909e63">USTATcopy</a> &amp; USTAT_EP_MASK)&gt;&gt;2];
<a name="l00763"></a>00763 <span class="preprocessor">        #else</span>
<a name="l00764"></a>00764 <span class="preprocessor"></span><span class="preprocessor">            #error "unimplemented"</span>
<a name="l00765"></a>00765 <span class="preprocessor"></span><span class="preprocessor">        #endif</span>
<a name="l00766"></a>00766 <span class="preprocessor"></span>
<a name="l00767"></a>00767                 <span class="comment">//Set the next out to the current out packet</span>
<a name="l00768"></a>00768         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a> = <a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>;
<a name="l00769"></a>00769                 <span class="comment">//Toggle it to the next ping pong buffer (if applicable)</span>
<a name="l00770"></a>00770         ((<a class="code" href="union___b_y_t_e___v_a_l.html">BYTE_VAL</a>*)&amp;<a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>)-&gt;<a class="code" href="union_____b_d_t.html#a0d915253ce32486d90c6b7ea39a5733">Val</a> ^= <a class="code" href="usb__device_8h.html#55d031747c4bd3e5e621f39d389a8182">USB_NEXT_EP0_OUT_PING_PONG</a>;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772                 <span class="comment">//If the current EP0 OUT buffer has a SETUP token</span>
<a name="l00773"></a>00773         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#8dc1a0d3225984a18c2d6b52dab33026">PID</a> == <a class="code" href="usb__device_8h.html#2c2773a05dd47f8a2432f1c2aa211ee3">SETUP_TOKEN</a>)
<a name="l00774"></a>00774         {
<a name="l00775"></a>00775                         <span class="comment">//Handle the control transfer</span>
<a name="l00776"></a>00776             <a class="code" href="usb__device_8h.html#4fd82120d0ce7ac5df27574b2fcd2b8f">USBCtrlTrfSetupHandler</a>();
<a name="l00777"></a>00777         }
<a name="l00778"></a>00778         <span class="keywordflow">else</span>
<a name="l00779"></a>00779         {
<a name="l00780"></a>00780                         <span class="comment">//Handle the DATA transfer</span>
<a name="l00781"></a>00781             <a class="code" href="usb__device_8h.html#d30a9aeba644af617b04c45333fc5125">USBCtrlTrfOutHandler</a>();
<a name="l00782"></a>00782         }
<a name="l00783"></a>00783     }
<a name="l00784"></a>00784     <span class="keywordflow">else</span> <span class="keywordflow">if</span>((<a class="code" href="usb__device_8c.html#b75c628c73eaac9e28acbff83a909e63">USTATcopy</a> &amp; USTAT_EP0_PP_MASK) == <a class="code" href="usb__hal__pic18_8h.html#282438e564df47143dd1ec3cbfcb7be2">USTAT_EP0_IN</a>)
<a name="l00785"></a>00785     {
<a name="l00786"></a>00786                 <span class="comment">//Otherwise the transmission was and EP0 IN</span>
<a name="l00787"></a>00787                 <span class="comment">//  so take care of the IN transfer</span>
<a name="l00788"></a>00788         <a class="code" href="usb__device_8h.html#8bfda535b2c9273a24983c1799f3fb42">USBCtrlTrfInHandler</a>();
<a name="l00789"></a>00789     }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 }<span class="comment">//end USBCtrlEPService</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_e5d35bef641e59de9a7279d639cc10b6_cgraph.png" border="0" usemap="#usb__device_8c_e5d35bef641e59de9a7279d639cc10b6_cgraph_map" alt=""></center>
<map name="usb__device_8c_e5d35bef641e59de9a7279d639cc10b6_cgraph_map">
<area shape="rect" href="usb__device_8h.html#8bfda535b2c9273a24983c1799f3fb42" title="USBCtrlTrfInHandler" alt="" coords="225,29,393,59"><area shape="rect" href="usb__device_8h.html#d30a9aeba644af617b04c45333fc5125" title="USBCtrlTrfOutHandler" alt="" coords="220,83,399,112"><area shape="rect" href="usb__device_8h.html#4fd82120d0ce7ac5df27574b2fcd2b8f" title="USBCtrlTrfSetupHandler" alt="" coords="211,163,408,192"><area shape="rect" href="usb__device_8h.html#6dde221e5c27eb18f62335810c830630" title="USBCtrlTrfTxService" alt="" coords="761,56,932,85"><area shape="rect" href="usb__device_8h.html#5fff309db0c489c108b02e5b0c665f3a" title="USBPrepareForNextSetupTrf" alt="" coords="456,29,688,59"><area shape="rect" href="usb__device_8h.html#8cc0ab9c4555c92370fe9d0ffb0685c7" title="USBCtrlTrfRxService" alt="" coords="487,83,657,112"><area shape="rect" href="usb__device_8h.html#a1730f3cc119bd8eb04d9b55ebed56e6" title="When SETUP packets arrive from the host, some firmware must process the request and..." alt="" coords="476,189,668,219"><area shape="rect" href="usb__device_8h.html#6d12a2e760ab2e6dc50498a76e3cfcc4" title="USBCheckStdRequest" alt="" coords="480,363,664,392"><area shape="rect" href="usb__device_8h.html#0913bb6b0a880a6e29d58c88c3c1e730" title="USBCtrlEPServiceComplete" alt="" coords="460,136,684,165"><area shape="rect" href="usb__function__hid_8h.html#5e0b02add954ecf19bcdef679a58988b" title="Section: PUBLIC PROTOTYPES." alt="" coords="753,149,940,179"><area shape="rect" href="usb__function__hid_8c.html#fb60fd12cb265cc70fd3b2d11802cd09" title="PRIVATE PROTOTYPES." alt="" coords="1031,96,1209,125"><area shape="rect" href="usb__function__hid_8c.html#6d8be1c6f7f1a3ffb6c3b56ae1f067a6" title="HIDSetReportHandler" alt="" coords="1032,149,1208,179"><area shape="rect" href="usb__device_8h.html#85c176c4ca674eb30b43b414f6a66260" title="The USBCBStdSetDscHandler() callback function is called when a SETUP, bRequest: SET_DESCRIPTOR..." alt="" coords="741,283,952,312"><area shape="rect" href="usb__device_8h.html#109b75c6ceba7a1ac93ac8653dae6405" title="USBStdFeatureReqHandler" alt="" coords="737,336,956,365"><area shape="rect" href="usb__device_8h.html#05d1ee4a1e4a8c8af6fb4816eba0a591" title="USBStdGetDscHandler" alt="" coords="753,389,940,419"><area shape="rect" href="usb__device_8h.html#07599ba7765be64baabac4e86cdb5358" title="USBStdGetStatusHandler" alt="" coords="745,443,948,472"><area shape="rect" href="usb__device_8h.html#23b85d487e9d3b37a4580138baf6b097" title="USBStdSetCfgHandler" alt="" coords="755,496,939,525"><area shape="rect" href="usb__otg_8h.html#df4bb848d4c77a2b5542dd3478bafa76" title="USBOTGDisableAltHnp" alt="" coords="1027,203,1213,232"><area shape="rect" href="usb__otg_8h.html#d078cd43132c6251de3865b19b8de4cb" title="USBOTGDisableHnp" alt="" coords="1035,256,1205,285"><area shape="rect" href="usb__otg_8h.html#6ea42b055d88fc42421bd7cb9c120a4a" title="USBOTGDisableSupportHnp" alt="" coords="1007,309,1233,339"><area shape="rect" href="usb__otg_8h.html#a79b51ab15ce5d80d5e4e78298c9d4c6" title="USBOTGEnableAltHnp" alt="" coords="1028,363,1212,392"><area shape="rect" href="usb__otg_8h.html#4055c7be50b72d3312c60ccce3464782" title="USBOTGEnableHnp" alt="" coords="1037,416,1203,445"><area shape="rect" href="usb__otg_8h.html#37a367b19b4b2f62c2dc0064f61d13fb" title="USBOTGEnableSupportHnp" alt="" coords="1008,469,1232,499"><area shape="rect" href="usb__device_8h.html#e69da16b1f966a62cdd1831df5561cbf" title="This function is called when the device becomes initialized, which occurs after the..." alt="" coords="1060,523,1180,552"><area shape="rect" href="usb__device_8h.html#25c6b82e249f563f00732a7e242c4267" title="USBEnableEndpoint" alt="" coords="1283,523,1451,552"><area shape="rect" href="usb__device_8h.html#1901fa27385226b6cdad1f5b091e5374" title="USBConfigureEndpoint" alt="" coords="1500,523,1689,552"></map>
</div>

</div>
</div><p>
<a class="anchor" name="0913bb6b0a880a6e29d58c88c3c1e730"></a><!-- doxytag: member="usb_device.c::USBCtrlEPServiceComplete" ref="0913bb6b0a880a6e29d58c88c3c1e730" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBCtrlEPServiceComplete           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01456"></a>01456 {
<a name="l01457"></a>01457     <span class="comment">/*</span>
<a name="l01458"></a>01458 <span class="comment">     * PKTDIS bit is set when a Setup Transaction is received.</span>
<a name="l01459"></a>01459 <span class="comment">     * Clear to resume packet processing.</span>
<a name="l01460"></a>01460 <span class="comment">     */</span>
<a name="l01461"></a>01461     <a class="code" href="usb__hal__pic18_8h.html#1147bb6143eebc90a11cb06ff1beed80">USBPacketDisable</a> = 0;
<a name="l01462"></a>01462 
<a name="l01463"></a>01463     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy == 0)
<a name="l01464"></a>01464     {
<a name="l01465"></a>01465         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].info.bits.busy == 1)
<a name="l01466"></a>01466         {
<a name="l01467"></a>01467             <a class="code" href="usb__device_8c.html#98752e9a61499b8a4998c0c3437cf73e">controlTransferState</a> = <a class="code" href="usb__device_8h.html#4c889997921d3278ecae3443e0ee97e1">CTRL_TRF_RX</a>;
<a name="l01468"></a>01468             <span class="comment">/*</span>
<a name="l01469"></a>01469 <span class="comment">             * Control Write:</span>
<a name="l01470"></a>01470 <span class="comment">             * &lt;SETUP[0]&gt;&lt;OUT[1]&gt;&lt;OUT[0]&gt;...&lt;IN[1]&gt; | &lt;SETUP[0]&gt;</span>
<a name="l01471"></a>01471 <span class="comment">             *</span>
<a name="l01472"></a>01472 <span class="comment">             * 1. Prepare IN EP to respond to early termination</span>
<a name="l01473"></a>01473 <span class="comment">             *</span>
<a name="l01474"></a>01474 <span class="comment">             *    This is the same as a Zero Length Packet Response</span>
<a name="l01475"></a>01475 <span class="comment">             *    for control transfer without a data stage</span>
<a name="l01476"></a>01476 <span class="comment">             */</span>
<a name="l01477"></a>01477             <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = 0;
<a name="l01478"></a>01478             <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l01479"></a>01479 
<a name="l01480"></a>01480             <span class="comment">/*</span>
<a name="l01481"></a>01481 <span class="comment">             * 2. Prepare OUT EP to receive data.</span>
<a name="l01482"></a>01482 <span class="comment">             */</span>
<a name="l01483"></a>01483             <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>;
<a name="l01484"></a>01484             <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>);
<a name="l01485"></a>01485             <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l01486"></a>01486         }
<a name="l01487"></a>01487         <span class="keywordflow">else</span>
<a name="l01488"></a>01488         {
<a name="l01489"></a>01489             <span class="comment">/*</span>
<a name="l01490"></a>01490 <span class="comment">             * If no one knows how to service this request then stall.</span>
<a name="l01491"></a>01491 <span class="comment">             * Must also prepare EP0 to receive the next SETUP transaction.</span>
<a name="l01492"></a>01492 <span class="comment">             */</span>
<a name="l01493"></a>01493             <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>;
<a name="l01494"></a>01494             <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>);
<a name="l01495"></a>01495     
<a name="l01496"></a>01496             <span class="comment">/* v2b fix */</span>
<a name="l01497"></a>01497             <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#6201ae0510cbe621aa0ae8f7e1f16653">_DAT0</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>|<a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>;
<a name="l01498"></a>01498             <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>; 
<a name="l01499"></a>01499         }
<a name="l01500"></a>01500     }
<a name="l01501"></a>01501     <span class="keywordflow">else</span>    <span class="comment">// A module has claimed ownership of the control transfer session.</span>
<a name="l01502"></a>01502     {
<a name="l01503"></a>01503         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].info.bits.busy == 0)
<a name="l01504"></a>01504         {
<a name="l01505"></a>01505                         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.DataDir == <a class="code" href="usb__device_8h.html#e5ac7b26141cfe4f7283c6bc37eccb48">DEV_TO_HOST</a>)
<a name="l01506"></a>01506                         {
<a name="l01507"></a>01507                                 <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.wLength &lt; <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.Val)
<a name="l01508"></a>01508                                 {
<a name="l01509"></a>01509                                         <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.Val = <a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.wLength;
<a name="l01510"></a>01510                                 }
<a name="l01511"></a>01511                                 <a class="code" href="usb__device_8h.html#6dde221e5c27eb18f62335810c830630">USBCtrlTrfTxService</a>();
<a name="l01512"></a>01512                                 <a class="code" href="usb__device_8c.html#98752e9a61499b8a4998c0c3437cf73e">controlTransferState</a> = <a class="code" href="usb__device_8h.html#16b60ce09eb50205ebccae05827fca53">CTRL_TRF_TX</a>;
<a name="l01513"></a>01513                                 <span class="comment">/*</span>
<a name="l01514"></a>01514 <span class="comment">                                 * Control Read:</span>
<a name="l01515"></a>01515 <span class="comment">                                 * &lt;SETUP[0]&gt;&lt;IN[1]&gt;&lt;IN[0]&gt;...&lt;OUT[1]&gt; | &lt;SETUP[0]&gt;</span>
<a name="l01516"></a>01516 <span class="comment">                                 * 1. Prepare OUT EP to respond to early termination</span>
<a name="l01517"></a>01517 <span class="comment">                                 *</span>
<a name="l01518"></a>01518 <span class="comment">                                 * NOTE:</span>
<a name="l01519"></a>01519 <span class="comment">                                 * If something went wrong during the control transfer,</span>
<a name="l01520"></a>01520 <span class="comment">                                 * the last status stage may not be sent by the host.</span>
<a name="l01521"></a>01521 <span class="comment">                                 * When this happens, two different things could happen</span>
<a name="l01522"></a>01522 <span class="comment">                                 * depending on the host.</span>
<a name="l01523"></a>01523 <span class="comment">                                 * a) The host could send out a RESET.</span>
<a name="l01524"></a>01524 <span class="comment">                                 * b) The host could send out a new SETUP transaction</span>
<a name="l01525"></a>01525 <span class="comment">                                 *    without sending a RESET first.</span>
<a name="l01526"></a>01526 <span class="comment">                                 * To properly handle case (b), the OUT EP must be setup</span>
<a name="l01527"></a>01527 <span class="comment">                                 * to receive either a zero length OUT transaction, or a</span>
<a name="l01528"></a>01528 <span class="comment">                                 * new SETUP transaction.</span>
<a name="l01529"></a>01529 <span class="comment">                                 *</span>
<a name="l01530"></a>01530 <span class="comment">                                 * Furthermore, the Cnt byte should be set to prepare for</span>
<a name="l01531"></a>01531 <span class="comment">                                 * the SETUP data (8-byte or more), and the buffer address</span>
<a name="l01532"></a>01532 <span class="comment">                                 * should be pointed to SetupPkt.</span>
<a name="l01533"></a>01533 <span class="comment">                                 */</span>
<a name="l01534"></a>01534                                 <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>;
<a name="l01535"></a>01535                                 <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>);
<a name="l01536"></a>01536                                 <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>;           <span class="comment">// Note: DTSEN is 0!</span>
<a name="l01537"></a>01537 
<a name="l01538"></a>01538                                 <a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>;
<a name="l01539"></a>01539                                 <a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>;
<a name="l01540"></a>01540                                 <a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>;           <span class="comment">// Note: DTSEN is 0!</span>
<a name="l01541"></a>01541 
<a name="l01542"></a>01542                                 <span class="comment">/*</span>
<a name="l01543"></a>01543 <span class="comment">                                 * 2. Prepare IN EP to transfer data, Cnt should have</span>
<a name="l01544"></a>01544 <span class="comment">                                 *    been initialized by responsible request owner.</span>
<a name="l01545"></a>01545 <span class="comment">                                 */</span>
<a name="l01546"></a>01546                                 <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>);
<a name="l01547"></a>01547                                 <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l01548"></a>01548                         }
<a name="l01549"></a>01549                         <span class="keywordflow">else</span>   <span class="comment">// (SetupPkt.DataDir == HOST_TO_DEVICE)</span>
<a name="l01550"></a>01550                         {
<a name="l01551"></a>01551                                 <a class="code" href="usb__device_8c.html#98752e9a61499b8a4998c0c3437cf73e">controlTransferState</a> = <a class="code" href="usb__device_8h.html#4c889997921d3278ecae3443e0ee97e1">CTRL_TRF_RX</a>;
<a name="l01552"></a>01552                                 <span class="comment">/*</span>
<a name="l01553"></a>01553 <span class="comment">                                 * Control Write:</span>
<a name="l01554"></a>01554 <span class="comment">                                 * &lt;SETUP[0]&gt;&lt;OUT[1]&gt;&lt;OUT[0]&gt;...&lt;IN[1]&gt; | &lt;SETUP[0]&gt;</span>
<a name="l01555"></a>01555 <span class="comment">                                 *</span>
<a name="l01556"></a>01556 <span class="comment">                                 * 1. Prepare IN EP to respond to early termination</span>
<a name="l01557"></a>01557 <span class="comment">                                 *</span>
<a name="l01558"></a>01558 <span class="comment">                                 *    This is the same as a Zero Length Packet Response</span>
<a name="l01559"></a>01559 <span class="comment">                                 *    for control transfer without a data stage</span>
<a name="l01560"></a>01560 <span class="comment">                                 */</span>
<a name="l01561"></a>01561                                 <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = 0;
<a name="l01562"></a>01562                                 <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l01563"></a>01563 
<a name="l01564"></a>01564                                 <span class="comment">/*</span>
<a name="l01565"></a>01565 <span class="comment">                                 * 2. Prepare OUT EP to receive data.</span>
<a name="l01566"></a>01566 <span class="comment">                                 */</span>
<a name="l01567"></a>01567                                 <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>;
<a name="l01568"></a>01568                                 <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>);
<a name="l01569"></a>01569                                 <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l01570"></a>01570                         }
<a name="l01571"></a>01571         }
<a name="l01572"></a>01572     }<span class="comment">//end if(ctrl_trf_session_owner == MUID_NULL)</span>
<a name="l01573"></a>01573 
<a name="l01574"></a>01574 }<span class="comment">//end USBCtrlEPServiceComplete</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_0913bb6b0a880a6e29d58c88c3c1e730_cgraph.png" border="0" usemap="#usb__device_8c_0913bb6b0a880a6e29d58c88c3c1e730_cgraph_map" alt=""></center>
<map name="usb__device_8c_0913bb6b0a880a6e29d58c88c3c1e730_cgraph_map">
<area shape="rect" href="usb__device_8h.html#6dde221e5c27eb18f62335810c830630" title="USBCtrlTrfTxService" alt="" coords="277,5,448,35"></map>
</div>

</div>
</div><p>
<a class="anchor" name="8bfda535b2c9273a24983c1799f3fb42"></a><!-- doxytag: member="usb_device.c::USBCtrlTrfInHandler" ref="8bfda535b2c9273a24983c1799f3fb42" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBCtrlTrfInHandler           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l00917"></a>00917 {
<a name="l00918"></a>00918     <a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> lastDTS;
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     lastDTS = <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#03a5d0d1ead08aa73f8e6b2e519cb8ea">DTS</a>;
<a name="l00921"></a>00921 
<a name="l00922"></a>00922     <span class="comment">//switch to the next ping pong buffer</span>
<a name="l00923"></a>00923     ((<a class="code" href="union___b_y_t_e___v_a_l.html">BYTE_VAL</a>*)&amp;<a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0])-&gt;Val ^= <a class="code" href="usb__device_8h.html#96cb2e1d960d598d505a6dfef7da21d6">USB_NEXT_EP0_IN_PING_PONG</a>;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <span class="comment">//mUSBCheckAdrPendingState();       // Must check if in ADR_PENDING_STATE</span>
<a name="l00926"></a>00926     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> == <a class="code" href="usb__device_8h.html#5e40c9d99b9b05d5a6c622afedf21f6b">ADR_PENDING_STATE</a>)
<a name="l00927"></a>00927     {
<a name="l00928"></a>00928         <a class="code" href="usb__hal__pic18_8h.html#a95a1fd5f4a385ab801bedc88728b4f2">U1ADDR</a> = <a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bDevADR.Val;
<a name="l00929"></a>00929         <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#a95a1fd5f4a385ab801bedc88728b4f2">U1ADDR</a> &gt; 0)
<a name="l00930"></a>00930         {
<a name="l00931"></a>00931             <a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a>=<a class="code" href="usb__device_8h.html#6bcec49c4751b6e53d47835eeca5651a">ADDRESS_STATE</a>;
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933         <span class="keywordflow">else</span>
<a name="l00934"></a>00934         {
<a name="l00935"></a>00935             <a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a>=<a class="code" href="usb__device_8h.html#f93d7c80faa6ebd086460cde2d5dd27e">DEFAULT_STATE</a>;
<a name="l00936"></a>00936         }
<a name="l00937"></a>00937     }<span class="comment">//end if</span>
<a name="l00938"></a>00938 
<a name="l00939"></a>00939 
<a name="l00940"></a>00940     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8c.html#98752e9a61499b8a4998c0c3437cf73e">controlTransferState</a> == <a class="code" href="usb__device_8h.html#16b60ce09eb50205ebccae05827fca53">CTRL_TRF_TX</a>)
<a name="l00941"></a>00941     {
<a name="l00942"></a>00942         <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(<a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>);
<a name="l00943"></a>00943         <a class="code" href="usb__device_8h.html#6dde221e5c27eb18f62335810c830630">USBCtrlTrfTxService</a>();
<a name="l00944"></a>00944 
<a name="l00945"></a>00945         <span class="comment">/* v2b fix */</span>
<a name="l00946"></a>00946         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8c.html#75b7cb53340c80ab6788fe4dc9ad5d48">shortPacketStatus</a> == <a class="code" href="usb__device_8h.html#17000e2642954ac728ba4f3050ae7d9a">SHORT_PKT_SENT</a>)
<a name="l00947"></a>00947         {
<a name="l00948"></a>00948             <span class="comment">// If a short packet has been sent, don't want to send any more,</span>
<a name="l00949"></a>00949             <span class="comment">// stall next time if host is still trying to read.</span>
<a name="l00950"></a>00950             <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>;
<a name="l00951"></a>00951         }
<a name="l00952"></a>00952         <span class="keywordflow">else</span>
<a name="l00953"></a>00953         {
<a name="l00954"></a>00954             <span class="keywordflow">if</span>(lastDTS == 0)
<a name="l00955"></a>00955             {
<a name="l00956"></a>00956                 <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l00957"></a>00957             }
<a name="l00958"></a>00958             <span class="keywordflow">else</span>
<a name="l00959"></a>00959             {
<a name="l00960"></a>00960                 <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#6201ae0510cbe621aa0ae8f7e1f16653">_DAT0</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l00961"></a>00961             }
<a name="l00962"></a>00962         }<span class="comment">//end if(...)else</span>
<a name="l00963"></a>00963     }
<a name="l00964"></a>00964     <span class="keywordflow">else</span> <span class="comment">// CTRL_TRF_RX</span>
<a name="l00965"></a>00965     {
<a name="l00966"></a>00966         <a class="code" href="usb__device_8h.html#5fff309db0c489c108b02e5b0c665f3a">USBPrepareForNextSetupTrf</a>();
<a name="l00967"></a>00967     }
<a name="l00968"></a>00968 }
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_8bfda535b2c9273a24983c1799f3fb42_cgraph.png" border="0" usemap="#usb__device_8c_8bfda535b2c9273a24983c1799f3fb42_cgraph_map" alt=""></center>
<map name="usb__device_8c_8bfda535b2c9273a24983c1799f3fb42_cgraph_map">
<area shape="rect" href="usb__device_8h.html#6dde221e5c27eb18f62335810c830630" title="USBCtrlTrfTxService" alt="" coords="255,5,425,35"><area shape="rect" href="usb__device_8h.html#5fff309db0c489c108b02e5b0c665f3a" title="USBPrepareForNextSetupTrf" alt="" coords="224,59,456,88"></map>
</div>

</div>
</div><p>
<a class="anchor" name="d30a9aeba644af617b04c45333fc5125"></a><!-- doxytag: member="usb_device.c::USBCtrlTrfOutHandler" ref="d30a9aeba644af617b04c45333fc5125" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBCtrlTrfOutHandler           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l00881"></a>00881 {
<a name="l00882"></a>00882     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8c.html#98752e9a61499b8a4998c0c3437cf73e">controlTransferState</a> == <a class="code" href="usb__device_8h.html#4c889997921d3278ecae3443e0ee97e1">CTRL_TRF_RX</a>)
<a name="l00883"></a>00883     {
<a name="l00884"></a>00884         <a class="code" href="usb__device_8h.html#8cc0ab9c4555c92370fe9d0ffb0685c7">USBCtrlTrfRxService</a>();
<a name="l00885"></a>00885     }
<a name="l00886"></a>00886     <span class="keywordflow">else</span>    <span class="comment">// CTRL_TRF_TX</span>
<a name="l00887"></a>00887     {
<a name="l00888"></a>00888         <a class="code" href="usb__device_8h.html#5fff309db0c489c108b02e5b0c665f3a">USBPrepareForNextSetupTrf</a>();
<a name="l00889"></a>00889     }
<a name="l00890"></a>00890 }
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_d30a9aeba644af617b04c45333fc5125_cgraph.png" border="0" usemap="#usb__device_8c_d30a9aeba644af617b04c45333fc5125_cgraph_map" alt=""></center>
<map name="usb__device_8c_d30a9aeba644af617b04c45333fc5125_cgraph_map">
<area shape="rect" href="usb__device_8h.html#8cc0ab9c4555c92370fe9d0ffb0685c7" title="USBCtrlTrfRxService" alt="" coords="265,5,436,35"><area shape="rect" href="usb__device_8h.html#5fff309db0c489c108b02e5b0c665f3a" title="USBPrepareForNextSetupTrf" alt="" coords="235,59,467,88"></map>
</div>

</div>
</div><p>
<a class="anchor" name="8cc0ab9c4555c92370fe9d0ffb0685c7"></a><!-- doxytag: member="usb_device.c::USBCtrlTrfRxService" ref="8cc0ab9c4555c92370fe9d0ffb0685c7" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBCtrlTrfRxService           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01689"></a>01689 {
<a name="l01690"></a>01690     <a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> byteToRead;
<a name="l01691"></a>01691     <a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i;
<a name="l01692"></a>01692 
<a name="l01693"></a>01693     byteToRead = <a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a>;
<a name="l01694"></a>01694 
<a name="l01695"></a>01695     <span class="comment">/*</span>
<a name="l01696"></a>01696 <span class="comment">     * Accumulate total number of bytes read</span>
<a name="l01697"></a>01697 <span class="comment">     */</span>
<a name="l01698"></a>01698     <span class="keywordflow">if</span>(byteToRead &gt; <a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].wCount.Val)
<a name="l01699"></a>01699     {
<a name="l01700"></a>01700         byteToRead = <a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].wCount.Val;
<a name="l01701"></a>01701     }
<a name="l01702"></a>01702     <span class="keywordflow">else</span>
<a name="l01703"></a>01703     {
<a name="l01704"></a>01704         <a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].wCount.Val = <a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].wCount.Val - byteToRead;
<a name="l01705"></a>01705     }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707     <span class="keywordflow">for</span>(i=0;i&lt;byteToRead;i++)
<a name="l01708"></a>01708     {
<a name="l01709"></a>01709         *<a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].pDst.bRam++ = <a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>[i];
<a name="l01710"></a>01710     }<span class="comment">//end while(byteToRead.Val)</span>
<a name="l01711"></a>01711 
<a name="l01712"></a>01712     <span class="comment">//If there is more data to read</span>
<a name="l01713"></a>01713     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].wCount.Val &gt; 0)
<a name="l01714"></a>01714     {
<a name="l01715"></a>01715         <span class="comment">/*</span>
<a name="l01716"></a>01716 <span class="comment">         * Don't have to worry about overwriting _KEEP bit</span>
<a name="l01717"></a>01717 <span class="comment">         * because if _KEEP was set, TRNIF would not have been</span>
<a name="l01718"></a>01718 <span class="comment">         * generated in the first place.</span>
<a name="l01719"></a>01719 <span class="comment">         */</span>
<a name="l01720"></a>01720         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>;
<a name="l01721"></a>01721         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>);
<a name="l01722"></a>01722         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#03a5d0d1ead08aa73f8e6b2e519cb8ea">DTS</a> == 0)
<a name="l01723"></a>01723         {
<a name="l01724"></a>01724             <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l01725"></a>01725         }
<a name="l01726"></a>01726         <span class="keywordflow">else</span>
<a name="l01727"></a>01727         {
<a name="l01728"></a>01728             <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#6201ae0510cbe621aa0ae8f7e1f16653">_DAT0</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l01729"></a>01729         }
<a name="l01730"></a>01730     }
<a name="l01731"></a>01731     <span class="keywordflow">else</span>
<a name="l01732"></a>01732     {
<a name="l01733"></a>01733         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>);
<a name="l01734"></a>01734         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].pFunc != <a class="code" href="_generic_type_defs_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01735"></a>01735         {
<a name="l01736"></a>01736             <a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].pFunc();
<a name="l01737"></a>01737         }
<a name="l01738"></a>01738         <a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].info.bits.busy = 0;
<a name="l01739"></a>01739     }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741 
<a name="l01742"></a>01742     <span class="comment">// reset ep0Bo.Cnt to USB_EP0_BUFF_SIZE</span>
<a name="l01743"></a>01743 
<a name="l01744"></a>01744 }<span class="comment">//end USBCtrlTrfRxService</span>
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="4fd82120d0ce7ac5df27574b2fcd2b8f"></a><!-- doxytag: member="usb_device.c::USBCtrlTrfSetupHandler" ref="4fd82120d0ce7ac5df27574b2fcd2b8f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBCtrlTrfSetupHandler           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l00834"></a>00834 {
<a name="l00835"></a>00835         <span class="comment">//if the SIE currently owns the buffer</span>
<a name="l00836"></a>00836     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;STAT.UOWN != 0)
<a name="l00837"></a>00837     {
<a name="l00838"></a>00838                 <span class="comment">//give control back to the CPU</span>
<a name="l00839"></a>00839                 <span class="comment">//  Compensate for after a STALL</span>
<a name="l00840"></a>00840         <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#91d20addc5cc0306cc07eeef1ced0c18">_UCPU</a>;           
<a name="l00841"></a>00841     }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843         <span class="comment">//Keep track of if a short packet has been sent yet or not</span>
<a name="l00844"></a>00844     <a class="code" href="usb__device_8c.html#75b7cb53340c80ab6788fe4dc9ad5d48">shortPacketStatus</a> = <a class="code" href="usb__device_8h.html#cc57480f7a348920ed322a3f62bed9a5">SHORT_PKT_NOT_USED</a>;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="comment">/* Stage 1 */</span>
<a name="l00847"></a>00847     <a class="code" href="usb__device_8c.html#98752e9a61499b8a4998c0c3437cf73e">controlTransferState</a> = <a class="code" href="usb__device_8h.html#e9a70c9f0037f259d10a26e476f52862">WAIT_SETUP</a>;
<a name="l00848"></a>00848 
<a name="l00849"></a>00849     <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.Val = 0;
<a name="l00850"></a>00850     <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.Val = 0;
<a name="l00851"></a>00851 
<a name="l00852"></a>00852     <span class="comment">/* Stage 2 */</span>
<a name="l00853"></a>00853     <a class="code" href="usb__device_8h.html#6d12a2e760ab2e6dc50498a76e3cfcc4">USBCheckStdRequest</a>();
<a name="l00854"></a>00854     <a class="code" href="usb__device_8h.html#a1730f3cc119bd8eb04d9b55ebed56e6" title="When SETUP packets arrive from the host, some firmware must process the request and...">USBCBCheckOtherReq</a>();   <span class="comment">// Required callback, see usbcallbacks.c</span>
<a name="l00855"></a>00855 
<a name="l00856"></a>00856     <span class="comment">/* Stage 3 */</span>
<a name="l00857"></a>00857     <a class="code" href="usb__device_8h.html#0913bb6b0a880a6e29d58c88c3c1e730">USBCtrlEPServiceComplete</a>();
<a name="l00858"></a>00858 
<a name="l00859"></a>00859 }<span class="comment">//end USBCtrlTrfSetupHandler</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_4fd82120d0ce7ac5df27574b2fcd2b8f_cgraph.png" border="0" usemap="#usb__device_8c_4fd82120d0ce7ac5df27574b2fcd2b8f_cgraph_map" alt=""></center>
<map name="usb__device_8c_4fd82120d0ce7ac5df27574b2fcd2b8f_cgraph_map">
<area shape="rect" href="usb__device_8h.html#a1730f3cc119bd8eb04d9b55ebed56e6" title="When SETUP packets arrive from the host, some firmware must process the request and..." alt="" coords="267,165,459,195"><area shape="rect" href="usb__device_8h.html#6d12a2e760ab2e6dc50498a76e3cfcc4" title="USBCheckStdRequest" alt="" coords="271,299,455,328"><area shape="rect" href="usb__device_8h.html#0913bb6b0a880a6e29d58c88c3c1e730" title="USBCtrlEPServiceComplete" alt="" coords="251,405,475,435"><area shape="rect" href="usb__function__hid_8h.html#5e0b02add954ecf19bcdef679a58988b" title="Section: PUBLIC PROTOTYPES." alt="" coords="540,59,727,88"><area shape="rect" href="usb__function__hid_8c.html#fb60fd12cb265cc70fd3b2d11802cd09" title="PRIVATE PROTOTYPES." alt="" coords="817,5,996,35"><area shape="rect" href="usb__function__hid_8c.html#6d8be1c6f7f1a3ffb6c3b56ae1f067a6" title="HIDSetReportHandler" alt="" coords="819,59,995,88"><area shape="rect" href="usb__device_8h.html#85c176c4ca674eb30b43b414f6a66260" title="The USBCBStdSetDscHandler() callback function is called when a SETUP, bRequest: SET_DESCRIPTOR..." alt="" coords="528,192,739,221"><area shape="rect" href="usb__device_8h.html#109b75c6ceba7a1ac93ac8653dae6405" title="USBStdFeatureReqHandler" alt="" coords="524,245,743,275"><area shape="rect" href="usb__device_8h.html#05d1ee4a1e4a8c8af6fb4816eba0a591" title="USBStdGetDscHandler" alt="" coords="540,299,727,328"><area shape="rect" href="usb__device_8h.html#07599ba7765be64baabac4e86cdb5358" title="USBStdGetStatusHandler" alt="" coords="532,352,735,381"><area shape="rect" href="usb__device_8h.html#23b85d487e9d3b37a4580138baf6b097" title="USBStdSetCfgHandler" alt="" coords="541,405,725,435"><area shape="rect" href="usb__otg_8h.html#df4bb848d4c77a2b5542dd3478bafa76" title="USBOTGDisableAltHnp" alt="" coords="813,112,1000,141"><area shape="rect" href="usb__otg_8h.html#d078cd43132c6251de3865b19b8de4cb" title="USBOTGDisableHnp" alt="" coords="821,165,992,195"><area shape="rect" href="usb__otg_8h.html#6ea42b055d88fc42421bd7cb9c120a4a" title="USBOTGDisableSupportHnp" alt="" coords="793,219,1020,248"><area shape="rect" href="usb__otg_8h.html#a79b51ab15ce5d80d5e4e78298c9d4c6" title="USBOTGEnableAltHnp" alt="" coords="815,272,999,301"><area shape="rect" href="usb__otg_8h.html#4055c7be50b72d3312c60ccce3464782" title="USBOTGEnableHnp" alt="" coords="824,325,989,355"><area shape="rect" href="usb__otg_8h.html#37a367b19b4b2f62c2dc0064f61d13fb" title="USBOTGEnableSupportHnp" alt="" coords="795,379,1019,408"><area shape="rect" href="usb__device_8h.html#e69da16b1f966a62cdd1831df5561cbf" title="This function is called when the device becomes initialized, which occurs after the..." alt="" coords="847,432,967,461"><area shape="rect" href="usb__device_8h.html#25c6b82e249f563f00732a7e242c4267" title="USBEnableEndpoint" alt="" coords="1069,432,1237,461"><area shape="rect" href="usb__device_8h.html#1901fa27385226b6cdad1f5b091e5374" title="USBConfigureEndpoint" alt="" coords="1287,432,1476,461"><area shape="rect" href="usb__device_8h.html#6dde221e5c27eb18f62335810c830630" title="USBCtrlTrfTxService" alt="" coords="548,459,719,488"></map>
</div>

</div>
</div><p>
<a class="anchor" name="6dde221e5c27eb18f62335810c830630"></a><!-- doxytag: member="usb_device.c::USBCtrlTrfTxService" ref="6dde221e5c27eb18f62335810c830630" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBCtrlTrfTxService           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01599"></a>01599 {
<a name="l01600"></a>01600     <a class="code" href="union___w_o_r_d___v_a_l.html">WORD_VAL</a> byteToSend;
<a name="l01601"></a>01601 
<a name="l01602"></a>01602     <span class="comment">/*</span>
<a name="l01603"></a>01603 <span class="comment">     * First, have to figure out how many byte of data to send.</span>
<a name="l01604"></a>01604 <span class="comment">     */</span>
<a name="l01605"></a>01605     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.Val &lt; <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>)
<a name="l01606"></a>01606     {
<a name="l01607"></a>01607         byteToSend.<a class="code" href="union___w_o_r_d___v_a_l.html#3b0f626d2e15ff5aa21804dd598d23c9">Val</a> = <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.Val;
<a name="l01608"></a>01608 
<a name="l01609"></a>01609         <span class="comment">/* v2b fix */</span>
<a name="l01610"></a>01610         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8c.html#75b7cb53340c80ab6788fe4dc9ad5d48">shortPacketStatus</a> == <a class="code" href="usb__device_8h.html#cc57480f7a348920ed322a3f62bed9a5">SHORT_PKT_NOT_USED</a>)
<a name="l01611"></a>01611         {
<a name="l01612"></a>01612             <a class="code" href="usb__device_8c.html#75b7cb53340c80ab6788fe4dc9ad5d48">shortPacketStatus</a> = <a class="code" href="usb__device_8h.html#e6c44308351e044b37ef7d8ebf8d32df">SHORT_PKT_PENDING</a>;
<a name="l01613"></a>01613         }
<a name="l01614"></a>01614         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="usb__device_8c.html#75b7cb53340c80ab6788fe4dc9ad5d48">shortPacketStatus</a> == <a class="code" href="usb__device_8h.html#e6c44308351e044b37ef7d8ebf8d32df">SHORT_PKT_PENDING</a>)
<a name="l01615"></a>01615         {
<a name="l01616"></a>01616             <a class="code" href="usb__device_8c.html#75b7cb53340c80ab6788fe4dc9ad5d48">shortPacketStatus</a> = <a class="code" href="usb__device_8h.html#17000e2642954ac728ba4f3050ae7d9a">SHORT_PKT_SENT</a>;
<a name="l01617"></a>01617         }<span class="comment">//end if</span>
<a name="l01618"></a>01618         <span class="comment">/* end v2b fix for this section */</span>
<a name="l01619"></a>01619     }
<a name="l01620"></a>01620     <span class="keywordflow">else</span>
<a name="l01621"></a>01621     {
<a name="l01622"></a>01622         byteToSend.<a class="code" href="union___w_o_r_d___v_a_l.html#3b0f626d2e15ff5aa21804dd598d23c9">Val</a> = <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>;
<a name="l01623"></a>01623     }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625     <span class="comment">/*</span>
<a name="l01626"></a>01626 <span class="comment">     * Next, load the number of bytes to send to BC9..0 in buffer descriptor</span>
<a name="l01627"></a>01627 <span class="comment">     */</span>
<a name="l01628"></a>01628 <span class="preprocessor">    #if defined(__18CXX)</span>
<a name="l01629"></a>01629 <span class="preprocessor"></span>        <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#63d79be8d915e05f2c3cd4a8c9f821d2">BC9</a> = 0;
<a name="l01630"></a>01630         <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#852378567beffc78926682fd3ebdf469">BC8</a> = 0;
<a name="l01631"></a>01631 <span class="preprocessor">    #endif</span>
<a name="l01632"></a>01632 <span class="preprocessor"></span>    
<a name="l01633"></a>01633 <span class="preprocessor">    #if defined(__18CXX) || defined(__C30__)</span>
<a name="l01634"></a>01634 <span class="preprocessor"></span>        <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> |= byteToSend.<a class="code" href="union___w_o_r_d___v_a_l.html#cdce4917ed4b8de7a7a0c07f21a56141">byte</a>.<a class="code" href="union___w_o_r_d___v_a_l.html#912b51805454255a794b26e6646c0cf1">HB</a>;
<a name="l01635"></a>01635         <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = byteToSend.<a class="code" href="union___w_o_r_d___v_a_l.html#cdce4917ed4b8de7a7a0c07f21a56141">byte</a>.<a class="code" href="union___w_o_r_d___v_a_l.html#a012d9c31fb3018cbe4d6a5052d98f51">LB</a>;
<a name="l01636"></a>01636 <span class="preprocessor">    #elif defined(__C32__)</span>
<a name="l01637"></a>01637 <span class="preprocessor"></span>        <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = byteToSend.<a class="code" href="union___w_o_r_d___v_a_l.html#3b0f626d2e15ff5aa21804dd598d23c9">Val</a>;
<a name="l01638"></a>01638 <span class="preprocessor">    #else</span>
<a name="l01639"></a>01639 <span class="preprocessor"></span><span class="preprocessor">        #error "Not defined for this compiler"</span>
<a name="l01640"></a>01640 <span class="preprocessor"></span><span class="preprocessor">    #endif</span>
<a name="l01641"></a>01641 <span class="preprocessor"></span>
<a name="l01642"></a>01642     <span class="comment">/*</span>
<a name="l01643"></a>01643 <span class="comment">     * Subtract the number of bytes just about to be sent from the total.</span>
<a name="l01644"></a>01644 <span class="comment">     */</span>
<a name="l01645"></a>01645     <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.Val = <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.Val - byteToSend.<a class="code" href="union___w_o_r_d___v_a_l.html#3b0f626d2e15ff5aa21804dd598d23c9">Val</a>;
<a name="l01646"></a>01646 
<a name="l01647"></a>01647     <a class="code" href="usb__device_8c.html#f268ebc32589a7de7b47922e44b97a55">pDst</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>;        <span class="comment">// Set destination pointer</span>
<a name="l01648"></a>01648 
<a name="l01649"></a>01649     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.ctrl_trf_mem == <a class="code" href="usb__device_8h.html#e9faaf3d10d03ed8f3406f7dc570701c">USB_INPIPES_ROM</a>)       <span class="comment">// Determine type of memory source</span>
<a name="l01650"></a>01650     {
<a name="l01651"></a>01651         <span class="keywordflow">while</span>(byteToSend.<a class="code" href="union___w_o_r_d___v_a_l.html#3b0f626d2e15ff5aa21804dd598d23c9">Val</a>)
<a name="l01652"></a>01652         {
<a name="l01653"></a>01653             *<a class="code" href="usb__device_8c.html#f268ebc32589a7de7b47922e44b97a55">pDst</a>++ = *<a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRom++;
<a name="l01654"></a>01654             byteToSend.<a class="code" href="union___w_o_r_d___v_a_l.html#3b0f626d2e15ff5aa21804dd598d23c9">Val</a>--;
<a name="l01655"></a>01655         }<span class="comment">//end while(byte_to_send.Val)</span>
<a name="l01656"></a>01656     }
<a name="l01657"></a>01657     <span class="keywordflow">else</span>  <span class="comment">// RAM</span>
<a name="l01658"></a>01658     {
<a name="l01659"></a>01659         <span class="keywordflow">while</span>(byteToSend.<a class="code" href="union___w_o_r_d___v_a_l.html#3b0f626d2e15ff5aa21804dd598d23c9">Val</a>)
<a name="l01660"></a>01660         {
<a name="l01661"></a>01661             *<a class="code" href="usb__device_8c.html#f268ebc32589a7de7b47922e44b97a55">pDst</a>++ = *<a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRam++;
<a name="l01662"></a>01662             byteToSend.<a class="code" href="union___w_o_r_d___v_a_l.html#3b0f626d2e15ff5aa21804dd598d23c9">Val</a>--;
<a name="l01663"></a>01663         }<span class="comment">//end while(byte_to_send.Val)</span>
<a name="l01664"></a>01664     }<span class="comment">//end if(usb_stat.ctrl_trf_mem == _ROM)</span>
<a name="l01665"></a>01665 
<a name="l01666"></a>01666 }<span class="comment">//end USBCtrlTrfTxService</span>
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="16da2c36e4eb6a018808f99f291433ca"></a><!-- doxytag: member="usb_device.c::USBDeviceInit" ref="16da2c36e4eb6a018808f99f291433ca" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBDeviceInit           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
DECLARATIONS. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00218"></a>00218 {
<a name="l00219"></a>00219     <a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="comment">// Clear all USB error flags</span>
<a name="l00222"></a>00222     USBClearInterruptRegister(<a class="code" href="usb__hal__pic18_8h.html#ba77d553dab6b24f442c2415b48d93e7">U1EIR</a>);  
<a name="l00223"></a>00223        
<a name="l00224"></a>00224     <span class="comment">// Clears all USB interrupts          </span>
<a name="l00225"></a>00225     USBClearInterruptRegister(<a class="code" href="usb__hal__pic18_8h.html#dcc39d6045679c6ea0af970ae03e3b32">U1IR</a>); 
<a name="l00226"></a>00226                        
<a name="l00227"></a>00227     <a class="code" href="usb__hal__pic18_8h.html#0b3412b3d119cc2cc6011135cc026480">U1EIE</a> = 0x9F;                   <span class="comment">// Unmask all USB error interrupts</span>
<a name="l00228"></a>00228     <a class="code" href="usb__hal__pic18_8h.html#ace4cb7e8cac3428ed0ab0a624387681">U1IE</a> = 0xFB;                    <span class="comment">// Enable all interrupts except ACTVIE</span>
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="comment">//power up the module</span>
<a name="l00231"></a>00231     <a class="code" href="usb__hal__pic18_8h.html#4e2e2e83460a45aafc4cad413f961121">USBPowerModule</a>();
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     <span class="comment">//set the address of the BDT (if applicable)</span>
<a name="l00234"></a>00234     <a class="code" href="usb__hal__pic18_8h.html#ea297a7523f0e65efb24f3e1ea99e168">USBSetBDTAddress</a>(BDT);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="comment">// Reset all of the Ping Pong buffers</span>
<a name="l00237"></a>00237     <a class="code" href="usb__hal__pic18_8h.html#612499127ebf5e2e32eeeb6f9b9e23ca">USBPingPongBufferReset</a> = 1;                    
<a name="l00238"></a>00238     <a class="code" href="usb__hal__pic18_8h.html#612499127ebf5e2e32eeeb6f9b9e23ca">USBPingPongBufferReset</a> = 0;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="comment">// Reset to default address</span>
<a name="l00241"></a>00241     <a class="code" href="usb__hal__pic18_8h.html#a95a1fd5f4a385ab801bedc88728b4f2">U1ADDR</a> = 0x00;                   
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="comment">//Clear all of the endpoint control registers</span>
<a name="l00244"></a>00244     memset((<span class="keywordtype">void</span>*)&amp;<a class="code" href="usb__hal__pic18_8h.html#2a55ce547263257dd0a25360d3636aa6">U1EP1</a>,0x00,(<a class="code" href="usb__config_8h.html#215684a6b1233e6db94531eca25f4d89">USB_MAX_EP_NUMBER</a>-1));
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="comment">//Clear all of the BDT entries</span>
<a name="l00247"></a>00247     <span class="keywordflow">for</span>(i=0;i&lt;(<span class="keyword">sizeof</span>(<a class="code" href="usb__device_8h.html#32640ece9cd65c03e939a98578f7232b" title="EXTERNS.">BDT</a>)/<span class="keyword">sizeof</span>(<a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>));i++)
<a name="l00248"></a>00248     {
<a name="l00249"></a>00249         <a class="code" href="usb__device_8h.html#32640ece9cd65c03e939a98578f7232b" title="EXTERNS.">BDT</a>[i].<a class="code" href="union_____b_d_t.html#a0d915253ce32486d90c6b7ea39a5733">Val</a> = 0x00;
<a name="l00250"></a>00250     }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252     <span class="comment">// Initialize EP0 as a Ctrl EP</span>
<a name="l00253"></a>00253     <a class="code" href="usb__hal__pic18_8h.html#ab50b71574d46f330f4f32d8897d6899">U1EP0</a> = EP_CTRL|USB_HANDSHAKE_ENABLED;        
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     <span class="comment">// Flush any pending transactions</span>
<a name="l00256"></a>00256     <span class="keywordflow">while</span>(<a class="code" href="usb__hal__pic18_8h.html#b164d7e7b5523f50dfa4e8b904751f23">USBTransactionCompleteIF</a> == 1)      
<a name="l00257"></a>00257     {
<a name="l00258"></a>00258         <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(<a class="code" href="usb__hal__pic18_8h.html#3d20ba855475d798e0fe74050f51a0d3">USBTransactionCompleteIFReg</a>,<a class="code" href="usb__hal__pic18_8h.html#b4908828a265e8e01ec3055d55fd4af3">USBTransactionCompleteIFBitNum</a>);
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     <span class="comment">//clear all of the internal pipe information</span>
<a name="l00262"></a>00262     <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.Val = 0;
<a name="l00263"></a>00263     <a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].info.Val = 0;
<a name="l00264"></a>00264     <a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].wCount.Val = 0;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="comment">// Make sure packet processing is enabled</span>
<a name="l00267"></a>00267     <a class="code" href="usb__hal__pic18_8h.html#1147bb6143eebc90a11cb06ff1beed80">USBPacketDisable</a> = 0;           
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="comment">//Get ready for the first packet</span>
<a name="l00270"></a>00270     <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0] = (<span class="keyword">volatile</span> <a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)&amp;BDT[<a class="code" href="usb__device_8h.html#8ce6a2e5374236aecc7bf3e923610bd4">EP0_IN_EVEN</a>];
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">// Clear active configuration</span>
<a name="l00273"></a>00273     <a class="code" href="usb__device_8h.html#91adced4a63e99db6b4b72faa09e78c5">USBActiveConfiguration</a> = 0;     
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="comment">//Indicate that we are now in the detached state        </span>
<a name="l00276"></a>00276     <a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> = <a class="code" href="usb__device_8h.html#f93e6ca83071e0b9716689d05a26b0e0">DETACHED_STATE</a>;
<a name="l00277"></a>00277 }
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_16da2c36e4eb6a018808f99f291433ca_cgraph.png" border="0" usemap="#usb__device_8c_16da2c36e4eb6a018808f99f291433ca_cgraph_map" alt=""></center>
<map name="usb__device_8c_16da2c36e4eb6a018808f99f291433ca_cgraph_map">
<area shape="rect" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc" title="USBClearInterruptFlag" alt="" coords="183,5,367,35"></map>
</div>

</div>
</div><p>
<a class="anchor" name="f35807553af66eab5b5d459fa13b274e"></a><!-- doxytag: member="usb_device.c::USBDeviceTasks" ref="f35807553af66eab5b5d459fa13b274e" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBDeviceTasks           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
PUBLIC PROTOTYPES. 
<p>
<div class="fragment"><pre class="fragment"><a name="l00312"></a>00312 {
<a name="l00313"></a>00313     <a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> i;
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 <span class="preprocessor">#ifdef USB_SUPPORT_OTG</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span>    <span class="comment">//SRP Time Out Check</span>
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (<a class="code" href="usb__otg_8h.html#074a26ffca9ba1473076efdb826d1771">USBOTGSRPIsReady</a>())
<a name="l00318"></a>00318     {
<a name="l00319"></a>00319         <span class="keywordflow">if</span> (USBT1MSECIF &amp;&amp; USBT1MSECIE)
<a name="l00320"></a>00320         {
<a name="l00321"></a>00321             <span class="keywordflow">if</span> (<a class="code" href="usb__otg_8h.html#78ca11f637dbda5615015004b1af7a43">USBOTGGetSRPTimeOutFlag</a>())
<a name="l00322"></a>00322             {
<a name="l00323"></a>00323                 <span class="keywordflow">if</span> (<a class="code" href="usb__otg_8h.html#f06c63d6f822660c4a2a3a52c29fd257">USBOTGIsSRPTimeOutExpired</a>())
<a name="l00324"></a>00324                 {
<a name="l00325"></a>00325                     <a class="code" href="usb__otg_8h.html#c5d1852c92a2364bf541966638962f42">USB_OTGEventHandler</a>(0,<a class="code" href="usb__otg_8h.html#84228e08cf7bb33ae71b42640fb7c594">OTG_EVENT_SRP_FAILED</a>,0,0);
<a name="l00326"></a>00326                 }       
<a name="l00327"></a>00327             }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329             <span class="comment">//Clear Interrupt Flag</span>
<a name="l00330"></a>00330             <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(USBT1MSECIFReg,USBT1MSECIFBitNum);
<a name="l00331"></a>00331         }
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333 <span class="preprocessor">#endif</span>
<a name="l00334"></a>00334 <span class="preprocessor"></span>
<a name="l00335"></a>00335     <span class="keywordflow">if</span> (<a class="code" href="_hardware_profile_8h.html#ec3d232fabd3960fba528e9386144a95">USB_BUS_SENSE</a> != 1)
<a name="l00336"></a>00336     {
<a name="l00337"></a>00337          <span class="comment">// Disable module &amp; detach from bus</span>
<a name="l00338"></a>00338          <a class="code" href="usb__hal__pic18_8h.html#75ece85672b3944ecb4a62cc858c3e84">U1CON</a> = 0;             
<a name="l00339"></a>00339 
<a name="l00340"></a>00340          <span class="comment">// Mask all USB interrupts              </span>
<a name="l00341"></a>00341          <a class="code" href="usb__hal__pic18_8h.html#ace4cb7e8cac3428ed0ab0a624387681">U1IE</a> = 0;          
<a name="l00342"></a>00342 
<a name="l00343"></a>00343          <span class="comment">//Move to the detached state                  </span>
<a name="l00344"></a>00344          <a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> = <a class="code" href="usb__device_8h.html#f93e6ca83071e0b9716689d05a26b0e0">DETACHED_STATE</a>;
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 <span class="preprocessor">         #ifdef  USB_SUPPORT_OTG    </span>
<a name="l00347"></a>00347 <span class="preprocessor"></span>             <span class="comment">//Disable D+ Pullup</span>
<a name="l00348"></a>00348              U1OTGCONbits.DPPULUP = 0;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350              <span class="comment">//Disable HNP</span>
<a name="l00351"></a>00351              <a class="code" href="usb__otg_8h.html#d078cd43132c6251de3865b19b8de4cb">USBOTGDisableHnp</a>();
<a name="l00352"></a>00352 
<a name="l00353"></a>00353              <span class="comment">//Deactivate HNP</span>
<a name="l00354"></a>00354              <a class="code" href="usb__otg_8h.html#f436961125c7e07df2081b53e4b37001">USBOTGDeactivateHnp</a>();
<a name="l00355"></a>00355              
<a name="l00356"></a>00356              <span class="comment">//If ID Pin Changed State</span>
<a name="l00357"></a>00357              <span class="keywordflow">if</span> (USBIDIF &amp;&amp; USBIDIE)
<a name="l00358"></a>00358              {  
<a name="l00359"></a>00359                  <span class="comment">//Re-detect &amp; Initialize</span>
<a name="l00360"></a>00360                   <a class="code" href="usb__otg_8h.html#1821d7229191e748ee716d497b14e5a2">USBOTGInitialize</a>();
<a name="l00361"></a>00361 
<a name="l00362"></a>00362                   <span class="comment">//Clear ID Interrupt Flag</span>
<a name="l00363"></a>00363                   <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(USBIDIFReg,USBIDIFBitNum);
<a name="l00364"></a>00364              }
<a name="l00365"></a>00365 <span class="preprocessor">         #endif</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>
<a name="l00367"></a>00367 <span class="preprocessor">         #ifdef __C30__</span>
<a name="l00368"></a>00368 <span class="preprocessor"></span>             <span class="comment">//USBClearInterruptFlag(U1OTGIR, 3); </span>
<a name="l00369"></a>00369 <span class="preprocessor">         #endif</span>
<a name="l00370"></a>00370 <span class="preprocessor"></span>            <span class="comment">//return so that we don't go through the rest of </span>
<a name="l00371"></a>00371             <span class="comment">//the state machine</span>
<a name="l00372"></a>00372           <span class="keywordflow">return</span>;
<a name="l00373"></a>00373     }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 <span class="preprocessor">#ifdef USB_SUPPORT_OTG</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span>    <span class="comment">//If Session Is Started Then</span>
<a name="l00377"></a>00377    <span class="keywordflow">else</span>
<a name="l00378"></a>00378    {
<a name="l00379"></a>00379         <span class="comment">//If SRP Is Ready</span>
<a name="l00380"></a>00380         <span class="keywordflow">if</span> (<a class="code" href="usb__otg_8h.html#074a26ffca9ba1473076efdb826d1771">USBOTGSRPIsReady</a>())
<a name="l00381"></a>00381         {   
<a name="l00382"></a>00382             <span class="comment">//Clear SRPReady</span>
<a name="l00383"></a>00383             <a class="code" href="usb__otg_8h.html#0e4aa57c5361e842d6ff6892aab573b6">USBOTGClearSRPReady</a>();
<a name="l00384"></a>00384 
<a name="l00385"></a>00385             <span class="comment">//Clear SRP Timeout Flag</span>
<a name="l00386"></a>00386             <a class="code" href="usb__otg_8h.html#d4bbe76141dea5928c75ce40938717e1">USBOTGClearSRPTimeOutFlag</a>();
<a name="l00387"></a>00387 
<a name="l00388"></a>00388             <span class="comment">//Indicate Session Started</span>
<a name="l00389"></a>00389             UART2PrintString( <span class="stringliteral">"\r\n***** USB OTG B Event - Session Started  *****\r\n"</span> );
<a name="l00390"></a>00390         }
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 <span class="preprocessor">#endif</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span>
<a name="l00394"></a>00394     <span class="comment">//if we are in the detached state</span>
<a name="l00395"></a>00395     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> == <a class="code" href="usb__device_8h.html#f93e6ca83071e0b9716689d05a26b0e0">DETACHED_STATE</a>)
<a name="l00396"></a>00396     {
<a name="l00397"></a>00397         <span class="comment">//#if defined(__18CXX)</span>
<a name="l00398"></a>00398             <a class="code" href="usb__hal__pic18_8h.html#75ece85672b3944ecb4a62cc858c3e84">U1CON</a> = 0;                           <span class="comment">// Disable module &amp; detach from bus</span>
<a name="l00399"></a>00399         <span class="comment">//#else</span>
<a name="l00400"></a>00400         <span class="comment">//#endif</span>
<a name="l00401"></a>00401 
<a name="l00402"></a>00402         <span class="comment">// Mask all USB interrupts</span>
<a name="l00403"></a>00403         <a class="code" href="usb__hal__pic18_8h.html#ace4cb7e8cac3428ed0ab0a624387681">U1IE</a> = 0;                                
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         <span class="comment">// Enable module &amp; attach to bus</span>
<a name="l00406"></a>00406         <span class="keywordflow">while</span>(!<a class="code" href="usb__hal__pic18_8h.html#faa3ceb75dda55243c5cff809a52f497">U1CONbits</a>.USBEN){<a class="code" href="usb__hal__pic18_8h.html#faa3ceb75dda55243c5cff809a52f497">U1CONbits</a>.USBEN = 1;}
<a name="l00407"></a>00407 
<a name="l00408"></a>00408         <span class="comment">//moved to the attached state</span>
<a name="l00409"></a>00409         <a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> = <a class="code" href="usb__device_8h.html#485fb1d1dd0df89593f2dfdfcd4fcad1">ATTACHED_STATE</a>;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         <span class="comment">//Enable/set things like: pull ups, full/low-speed mode, </span>
<a name="l00412"></a>00412         <span class="comment">//set the ping pong mode, and set internal transceiver</span>
<a name="l00413"></a>00413         SetConfigurationOptions();
<a name="l00414"></a>00414 
<a name="l00415"></a>00415 <span class="preprocessor">        #ifdef  USB_SUPPORT_OTG</span>
<a name="l00416"></a>00416 <span class="preprocessor"></span>            U1OTGCON = USB_OTG_DPLUS_ENABLE | USB_OTG_ENABLE;  
<a name="l00417"></a>00417 <span class="preprocessor">        #endif</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span>    }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> == <a class="code" href="usb__device_8h.html#485fb1d1dd0df89593f2dfdfcd4fcad1">ATTACHED_STATE</a>)
<a name="l00421"></a>00421     {
<a name="l00422"></a>00422         <span class="comment">/*</span>
<a name="l00423"></a>00423 <span class="comment">         * After enabling the USB module, it takes some time for the</span>
<a name="l00424"></a>00424 <span class="comment">         * voltage on the D+ or D- line to rise high enough to get out</span>
<a name="l00425"></a>00425 <span class="comment">         * of the SE0 condition. The USB Reset interrupt should not be</span>
<a name="l00426"></a>00426 <span class="comment">         * unmasked until the SE0 condition is cleared. This helps</span>
<a name="l00427"></a>00427 <span class="comment">         * prevent the firmware from misinterpreting this unique event</span>
<a name="l00428"></a>00428 <span class="comment">         * as a USB bus reset from the USB host.</span>
<a name="l00429"></a>00429 <span class="comment">         */</span>
<a name="l00430"></a>00430 
<a name="l00431"></a>00431         <span class="keywordflow">if</span>(!<a class="code" href="usb__hal__pic18_8h.html#9c22aec8d04ded14faa7d2a32fb5fce1">USBSE0Event</a>)
<a name="l00432"></a>00432         {
<a name="l00433"></a>00433             USBClearInterruptRegister(<a class="code" href="usb__hal__pic18_8h.html#dcc39d6045679c6ea0af970ae03e3b32">U1IR</a>);<span class="comment">// Clear all USB interrupts</span>
<a name="l00434"></a>00434             <a class="code" href="usb__hal__pic18_8h.html#ace4cb7e8cac3428ed0ab0a624387681">U1IE</a>=0;                        <span class="comment">// Mask all USB interrupts</span>
<a name="l00435"></a>00435             <a class="code" href="usb__hal__pic18_8h.html#135d9b4b16e8d7d3f1c822e1d9440ac1">USBResetIE</a> = 1;             <span class="comment">// Unmask RESET interrupt</span>
<a name="l00436"></a>00436             <a class="code" href="usb__hal__pic18_8h.html#c77598e4746dced17902482a27a4e47c">USBIdleIE</a> = 1;             <span class="comment">// Unmask IDLE interrupt</span>
<a name="l00437"></a>00437             <a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> = <a class="code" href="usb__device_8h.html#8dab51c2d5fd7f95bba6c9c10106b989">POWERED_STATE</a>;
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 <span class="preprocessor">    #ifdef  USB_SUPPORT_OTG</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span>        <span class="comment">//If ID Pin Changed State</span>
<a name="l00443"></a>00443         <span class="keywordflow">if</span> (USBIDIF &amp;&amp; USBIDIE)
<a name="l00444"></a>00444         {  
<a name="l00445"></a>00445             <span class="comment">//Re-detect &amp; Initialize</span>
<a name="l00446"></a>00446             <a class="code" href="usb__otg_8h.html#1821d7229191e748ee716d497b14e5a2">USBOTGInitialize</a>();
<a name="l00447"></a>00447 
<a name="l00448"></a>00448             <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(USBIDIFReg,USBIDIFBitNum);
<a name="l00449"></a>00449         }
<a name="l00450"></a>00450 <span class="preprocessor">    #endif</span>
<a name="l00451"></a>00451 <span class="preprocessor"></span>
<a name="l00452"></a>00452     <span class="comment">/*</span>
<a name="l00453"></a>00453 <span class="comment">     * Task A: Service USB Activity Interrupt</span>
<a name="l00454"></a>00454 <span class="comment">     */</span>
<a name="l00455"></a>00455     <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#8f7bffd17b97ace69f56b1ea4c12494d">USBActivityIF</a> &amp;&amp; <a class="code" href="usb__hal__pic18_8h.html#e3d8d210b042931cd6914386ae628a83">USBActivityIE</a>)
<a name="l00456"></a>00456     {
<a name="l00457"></a>00457 <span class="preprocessor">        #if defined(USB_SUPPORT_OTG)</span>
<a name="l00458"></a>00458 <span class="preprocessor"></span>        <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(<a class="code" href="usb__hal__pic18_8h.html#37b135c121927e6ab18faa13beb11962">USBActivityIFReg</a>,<a class="code" href="usb__hal__pic18_8h.html#74bc2ce00ddc8122a0a2f7af76e721d0">USBActivityIFBitNum</a>);
<a name="l00459"></a>00459             U1OTGIR = 0x10;        
<a name="l00460"></a>00460 <span class="preprocessor">        #else</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span>            <a class="code" href="usb__device_8h.html#9104bea8c7f5045558f6cc5721e7455f">USBWakeFromSuspend</a>();
<a name="l00462"></a>00462 <span class="preprocessor">        #endif</span>
<a name="l00463"></a>00463 <span class="preprocessor"></span>    }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <span class="comment">/*</span>
<a name="l00466"></a>00466 <span class="comment">     * Pointless to continue servicing if the device is in suspend mode.</span>
<a name="l00467"></a>00467 <span class="comment">     */</span>
<a name="l00468"></a>00468     <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#692643ef2e9ce498623a4f83b60952ce">USBSuspendControl</a>==1)
<a name="l00469"></a>00469     {
<a name="l00470"></a>00470         <span class="keywordflow">return</span>;
<a name="l00471"></a>00471     }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <span class="comment">/*</span>
<a name="l00474"></a>00474 <span class="comment">     * Task B: Service USB Bus Reset Interrupt.</span>
<a name="l00475"></a>00475 <span class="comment">     * When bus reset is received during suspend, ACTVIF will be set first,</span>
<a name="l00476"></a>00476 <span class="comment">     * once the UCONbits.SUSPND is clear, then the URSTIF bit will be asserted.</span>
<a name="l00477"></a>00477 <span class="comment">     * This is why URSTIF is checked after ACTVIF.</span>
<a name="l00478"></a>00478 <span class="comment">     *</span>
<a name="l00479"></a>00479 <span class="comment">     * The USB reset flag is masked when the USB state is in</span>
<a name="l00480"></a>00480 <span class="comment">     * DETACHED_STATE or ATTACHED_STATE, and therefore cannot</span>
<a name="l00481"></a>00481 <span class="comment">     * cause a USB reset event during these two states.</span>
<a name="l00482"></a>00482 <span class="comment">     */</span>
<a name="l00483"></a>00483     <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#94be8ce25f666ac961c7f6fb1e1bfffd">USBResetIF</a> &amp;&amp; <a class="code" href="usb__hal__pic18_8h.html#135d9b4b16e8d7d3f1c822e1d9440ac1">USBResetIE</a>)
<a name="l00484"></a>00484     {
<a name="l00485"></a>00485         <a class="code" href="usb__device_8h.html#16da2c36e4eb6a018808f99f291433ca" title="DECLARATIONS.">USBDeviceInit</a>();
<a name="l00486"></a>00486         <a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> = <a class="code" href="usb__device_8h.html#f93d7c80faa6ebd086460cde2d5dd27e">DEFAULT_STATE</a>;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488         <span class="comment">/********************************************************************</span>
<a name="l00489"></a>00489 <span class="comment">        Bug Fix: Feb 26, 2007 v2.1 (#F1)</span>
<a name="l00490"></a>00490 <span class="comment">        *********************************************************************</span>
<a name="l00491"></a>00491 <span class="comment">        In the original firmware, if an OUT token is sent by the host</span>
<a name="l00492"></a>00492 <span class="comment">        before a SETUP token is sent, the firmware would respond with an ACK.</span>
<a name="l00493"></a>00493 <span class="comment">        This is not a correct response, the firmware should have sent a STALL.</span>
<a name="l00494"></a>00494 <span class="comment">        This is a minor non-compliance since a compliant host should not</span>
<a name="l00495"></a>00495 <span class="comment">        send an OUT before sending a SETUP token. The fix allows a SETUP</span>
<a name="l00496"></a>00496 <span class="comment">        transaction to be accepted while stalling OUT transactions.</span>
<a name="l00497"></a>00497 <span class="comment">        ********************************************************************/</span>
<a name="l00498"></a>00498         <a class="code" href="usb__device_8h.html#32640ece9cd65c03e939a98578f7232b" title="EXTERNS.">BDT</a>[<a class="code" href="usb__device_8h.html#6f1d734edb188a0d6d7bdfc1501e683c">EP0_OUT_EVEN</a>].<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>);
<a name="l00499"></a>00499         <a class="code" href="usb__device_8h.html#32640ece9cd65c03e939a98578f7232b" title="EXTERNS.">BDT</a>[<a class="code" href="usb__device_8h.html#6f1d734edb188a0d6d7bdfc1501e683c">EP0_OUT_EVEN</a>].<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>;
<a name="l00500"></a>00500         <a class="code" href="usb__device_8h.html#32640ece9cd65c03e939a98578f7232b" title="EXTERNS.">BDT</a>[<a class="code" href="usb__device_8h.html#6f1d734edb188a0d6d7bdfc1501e683c">EP0_OUT_EVEN</a>].<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> &amp;= ~<a class="code" href="usb__hal__pic18_8h.html#497b78442b79a0c2c611e75ed1e8fa65">_STAT_MASK</a>;
<a name="l00501"></a>00501         <a class="code" href="usb__device_8h.html#32640ece9cd65c03e939a98578f7232b" title="EXTERNS.">BDT</a>[<a class="code" href="usb__device_8h.html#6f1d734edb188a0d6d7bdfc1501e683c">EP0_OUT_EVEN</a>].<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> |= <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#6201ae0510cbe621aa0ae8f7e1f16653">_DAT0</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>|<a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="preprocessor">        #ifdef USB_SUPPORT_OTG</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span>             <span class="comment">//Disable HNP</span>
<a name="l00505"></a>00505              <a class="code" href="usb__otg_8h.html#d078cd43132c6251de3865b19b8de4cb">USBOTGDisableHnp</a>();
<a name="l00506"></a>00506 
<a name="l00507"></a>00507              <span class="comment">//Deactivate HNP</span>
<a name="l00508"></a>00508              <a class="code" href="usb__otg_8h.html#f436961125c7e07df2081b53e4b37001">USBOTGDeactivateHnp</a>();
<a name="l00509"></a>00509 <span class="preprocessor">        #endif</span>
<a name="l00510"></a>00510 <span class="preprocessor"></span>    }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <span class="comment">/*</span>
<a name="l00513"></a>00513 <span class="comment">     * Task C: Service other USB interrupts</span>
<a name="l00514"></a>00514 <span class="comment">     */</span>
<a name="l00515"></a>00515     <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#cd543c90e09c93e984a634c0bbbbd689">USBIdleIF</a> &amp;&amp; <a class="code" href="usb__hal__pic18_8h.html#c77598e4746dced17902482a27a4e47c">USBIdleIE</a>)
<a name="l00516"></a>00516     { 
<a name="l00517"></a>00517 <span class="preprocessor">        #ifdef  USB_SUPPORT_OTG </span>
<a name="l00518"></a>00518 <span class="preprocessor"></span>            <span class="comment">//If Suspended, Try to switch to Host</span>
<a name="l00519"></a>00519             <a class="code" href="usb__otg_8h.html#6b7e526fa731f878145d8a05ac1afc02">USBOTGSelectRole</a>(<a class="code" href="usb__otg_8h.html#8c68bccc5001df9a24fe16dd32ba113d">ROLE_HOST</a>);
<a name="l00520"></a>00520 <span class="preprocessor">        #else</span>
<a name="l00521"></a>00521 <span class="preprocessor"></span>            <a class="code" href="usb__device_8h.html#1e0966febda8e01d2e4e58ceb42dd46a">USBSuspend</a>();
<a name="l00522"></a>00522 <span class="preprocessor">        #endif</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span>        
<a name="l00524"></a>00524         <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(<a class="code" href="usb__hal__pic18_8h.html#31f387320cef0c78a8ffee918613433e">USBIdleIFReg</a>,<a class="code" href="usb__hal__pic18_8h.html#e231304475b5d55192b196d14403d36b">USBIdleIFBitNum</a>);
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#2db31e4ca980a0565bff48559cc6f77d">USBSOFIF</a> &amp;&amp; <a class="code" href="usb__hal__pic18_8h.html#8a84f6e934b9ee7ec78b1f40e3f3be55">USBSOFIE</a>)
<a name="l00528"></a>00528     {
<a name="l00529"></a>00529         <a class="code" href="usb__device_8h.html#d39fa1008b49fb91555086e40710d573" title="The USB host sends out a SOF packet to full-speed devices every 1 ms.">USBCB_SOF_Handler</a>();    <span class="comment">// Required callback, see usbcallbacks.c</span>
<a name="l00530"></a>00530         <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(<a class="code" href="usb__hal__pic18_8h.html#9e423210de15659bf3a1daf9b55e9d26">USBSOFIFReg</a>,<a class="code" href="usb__hal__pic18_8h.html#4b062b9eabbb692203eee1513216f88a">USBSOFIFBitNum</a>);
<a name="l00531"></a>00531     }
<a name="l00532"></a>00532 
<a name="l00533"></a>00533     <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#cb18cda95d79d79a69411e906ec22318">USBStallIF</a> &amp;&amp; <a class="code" href="usb__hal__pic18_8h.html#c12cfca45d66a5e1b1616c770e0e5263">USBStallIE</a>)
<a name="l00534"></a>00534     {
<a name="l00535"></a>00535         <a class="code" href="usb__device_8h.html#f7fca92a339183ae8f268bb8c3ca4e7e">USBStallHandler</a>();
<a name="l00536"></a>00536     }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538     <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#b4481f452e15aa6680a5ef4f4d40f36e">USBErrorIF</a> &amp;&amp; <a class="code" href="usb__hal__pic18_8h.html#6192f2c6c3884d62e6e5f0d9ff5377fa">USBErrorIE</a>)
<a name="l00539"></a>00539     {
<a name="l00540"></a>00540         <a class="code" href="usb__device_8h.html#e6717d77804b36ca26a975fd0bee6f01" title="The purpose of this callback is mainly for debugging during development.">USBCBErrorHandler</a>();    <span class="comment">// Required callback, see usbcallbacks.c</span>
<a name="l00541"></a>00541         USBClearInterruptRegister(<a class="code" href="usb__hal__pic18_8h.html#ba77d553dab6b24f442c2415b48d93e7">U1EIR</a>);               <span class="comment">// This clears UERRIF</span>
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="comment">/*</span>
<a name="l00545"></a>00545 <span class="comment">     * Pointless to continue servicing if the host has not sent a bus reset.</span>
<a name="l00546"></a>00546 <span class="comment">     * Once bus reset is received, the device transitions into the DEFAULT</span>
<a name="l00547"></a>00547 <span class="comment">     * state and is ready for communication.</span>
<a name="l00548"></a>00548 <span class="comment">     */</span>
<a name="l00549"></a>00549     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> &lt; <a class="code" href="usb__device_8h.html#f93d7c80faa6ebd086460cde2d5dd27e">DEFAULT_STATE</a>) <span class="keywordflow">return</span>;
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <span class="comment">/*</span>
<a name="l00552"></a>00552 <span class="comment">     * Task D: Servicing USB Transaction Complete Interrupt</span>
<a name="l00553"></a>00553 <span class="comment">     */</span>
<a name="l00554"></a>00554     <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#e8e52d33d9cfdbac578ead22b2e26c62">USBTransactionCompleteIE</a>)
<a name="l00555"></a>00555     {
<a name="l00556"></a>00556             <span class="keywordflow">for</span>(i = 0; i &lt; 4; i++)      <span class="comment">//Drain or deplete the USAT FIFO entries.  If the USB FIFO ever gets full, USB bandwidth </span>
<a name="l00557"></a>00557                 {                                               <span class="comment">//utilization can be compromised, and the device won't be able to receive SETUP packets.</span>
<a name="l00558"></a>00558                     <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#b164d7e7b5523f50dfa4e8b904751f23">USBTransactionCompleteIF</a>)
<a name="l00559"></a>00559                     {
<a name="l00560"></a>00560                         <a class="code" href="usb__device_8c.html#b75c628c73eaac9e28acbff83a909e63">USTATcopy</a> = <a class="code" href="usb__hal__pic18_8h.html#f8e918d3f91c8db3205a262468308e6e">U1STAT</a>;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562                         <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(<a class="code" href="usb__hal__pic18_8h.html#3d20ba855475d798e0fe74050f51a0d3">USBTransactionCompleteIFReg</a>,<a class="code" href="usb__hal__pic18_8h.html#b4908828a265e8e01ec3055d55fd4af3">USBTransactionCompleteIFBitNum</a>);
<a name="l00563"></a>00563                 
<a name="l00564"></a>00564                         <span class="comment">/*</span>
<a name="l00565"></a>00565 <span class="comment">                         * USBCtrlEPService only services transactions over EP0.</span>
<a name="l00566"></a>00566 <span class="comment">                         * It ignores all other EP transactions.</span>
<a name="l00567"></a>00567 <span class="comment">                         */</span>
<a name="l00568"></a>00568                         <a class="code" href="usb__device_8h.html#e5d35bef641e59de9a7279d639cc10b6">USBCtrlEPService</a>();
<a name="l00569"></a>00569                     }<span class="comment">//end if(USBTransactionCompleteIF)</span>
<a name="l00570"></a>00570                     <span class="keywordflow">else</span>
<a name="l00571"></a>00571                         <span class="keywordflow">break</span>;  <span class="comment">//USTAT FIFO must be empty.</span>
<a name="l00572"></a>00572                 }<span class="comment">//end for()</span>
<a name="l00573"></a>00573         }<span class="comment">//end if(USBTransactionCompleteIE)</span>
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 }<span class="comment">//end of USBDeviceTasks()</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_f35807553af66eab5b5d459fa13b274e_cgraph.png" border="0" usemap="#usb__device_8c_f35807553af66eab5b5d459fa13b274e_cgraph_map" alt=""></center>
<map name="usb__device_8c_f35807553af66eab5b5d459fa13b274e_cgraph_map">
<area shape="rect" href="usb__otg_8h.html#c5d1852c92a2364bf541966638962f42" title="USB_OTGEventHandler" alt="" coords="229,5,421,35"><area shape="rect" href="usb__device_8h.html#d39fa1008b49fb91555086e40710d573" title="The USB host sends out a SOF packet to full&#45;speed devices every 1 ms." alt="" coords="233,59,417,88"><area shape="rect" href="usb__device_8h.html#e6717d77804b36ca26a975fd0bee6f01" title="The purpose of this callback is mainly for debugging during development." alt="" coords="240,112,411,141"><area shape="rect" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc" title="USBClearInterruptFlag" alt="" coords="519,269,703,299"><area shape="rect" href="usb__device_8h.html#e5d35bef641e59de9a7279d639cc10b6" title="USBCtrlEPService" alt="" coords="248,480,403,509"><area shape="rect" href="usb__otg_8h.html#d078cd43132c6251de3865b19b8de4cb" title="USBOTGDisableHnp" alt="" coords="1349,427,1520,456"><area shape="rect" href="usb__device_8h.html#16da2c36e4eb6a018808f99f291433ca" title="DECLARATIONS." alt="" coords="263,216,388,245"><area shape="rect" href="usb__otg_8h.html#0e4aa57c5361e842d6ff6892aab573b6" title="USBOTGClearSRPReady" alt="" coords="223,533,428,563"><area shape="rect" href="usb__otg_8h.html#d4bbe76141dea5928c75ce40938717e1" title="USBOTGClearSRPTimeOutFlag" alt="" coords="200,587,451,616"><area shape="rect" href="usb__otg_8h.html#f436961125c7e07df2081b53e4b37001" title="USBOTGDeactivateHnp" alt="" coords="229,640,421,669"><area shape="rect" href="usb__otg_8h.html#78ca11f637dbda5615015004b1af7a43" title="USBOTGGetSRPTimeOutFlag" alt="" coords="208,693,443,723"><area shape="rect" href="usb__otg_8h.html#1821d7229191e748ee716d497b14e5a2" title="USBOTGInitialize" alt="" coords="252,747,399,776"><area shape="rect" href="usb__otg_8h.html#f06c63d6f822660c4a2a3a52c29fd257" title="USBOTGIsSRPTimeOutExpired" alt="" coords="201,800,449,829"><area shape="rect" href="usb__otg_8h.html#6b7e526fa731f878145d8a05ac1afc02" title="USBOTGSelectRole" alt="" coords="244,853,407,883"><area shape="rect" href="usb__otg_8h.html#074a26ffca9ba1473076efdb826d1771" title="USBOTGSRPIsReady" alt="" coords="236,907,415,936"><area shape="rect" href="usb__device_8h.html#f7fca92a339183ae8f268bb8c3ca4e7e" title="USBStallHandler" alt="" coords="256,269,395,299"><area shape="rect" href="usb__device_8h.html#1e0966febda8e01d2e4e58ceb42dd46a" title="USBSuspend" alt="" coords="267,323,384,352"><area shape="rect" href="usb__device_8h.html#9104bea8c7f5045558f6cc5721e7455f" title="USBWakeFromSuspend" alt="" coords="225,376,425,405"><area shape="rect" href="usb__device_8h.html#8bfda535b2c9273a24983c1799f3fb42" title="USBCtrlTrfInHandler" alt="" coords="527,748,695,777"><area shape="rect" href="usb__device_8h.html#d30a9aeba644af617b04c45333fc5125" title="USBCtrlTrfOutHandler" alt="" coords="521,695,700,724"><area shape="rect" href="usb__device_8h.html#4fd82120d0ce7ac5df27574b2fcd2b8f" title="USBCtrlTrfSetupHandler" alt="" coords="512,561,709,591"><area shape="rect" href="usb__device_8h.html#6dde221e5c27eb18f62335810c830630" title="USBCtrlTrfTxService" alt="" coords="1076,800,1247,829"><area shape="rect" href="usb__device_8h.html#5fff309db0c489c108b02e5b0c665f3a" title="USBPrepareForNextSetupTrf" alt="" coords="771,748,1003,777"><area shape="rect" href="usb__device_8h.html#8cc0ab9c4555c92370fe9d0ffb0685c7" title="USBCtrlTrfRxService" alt="" coords="801,695,972,724"><area shape="rect" href="usb__device_8h.html#a1730f3cc119bd8eb04d9b55ebed56e6" title="When SETUP packets arrive from the host, some firmware must process the request and..." alt="" coords="791,588,983,617"><area shape="rect" href="usb__device_8h.html#6d12a2e760ab2e6dc50498a76e3cfcc4" title="USBCheckStdRequest" alt="" coords="795,535,979,564"><area shape="rect" href="usb__device_8h.html#0913bb6b0a880a6e29d58c88c3c1e730" title="USBCtrlEPServiceComplete" alt="" coords="775,641,999,671"><area shape="rect" href="usb__function__hid_8h.html#5e0b02add954ecf19bcdef679a58988b" title="Section: PUBLIC PROTOTYPES." alt="" coords="1068,747,1255,776"><area shape="rect" href="usb__function__hid_8c.html#fb60fd12cb265cc70fd3b2d11802cd09" title="PRIVATE PROTOTYPES." alt="" coords="1345,800,1524,829"><area shape="rect" href="usb__function__hid_8c.html#6d8be1c6f7f1a3ffb6c3b56ae1f067a6" title="HIDSetReportHandler" alt="" coords="1347,747,1523,776"><area shape="rect" href="usb__device_8h.html#85c176c4ca674eb30b43b414f6a66260" title="The USBCBStdSetDscHandler() callback function is called when a SETUP, bRequest: SET_DESCRIPTOR..." alt="" coords="1056,533,1267,563"><area shape="rect" href="usb__device_8h.html#109b75c6ceba7a1ac93ac8653dae6405" title="USBStdFeatureReqHandler" alt="" coords="1052,587,1271,616"><area shape="rect" href="usb__device_8h.html#05d1ee4a1e4a8c8af6fb4816eba0a591" title="USBStdGetDscHandler" alt="" coords="1068,640,1255,669"><area shape="rect" href="usb__device_8h.html#07599ba7765be64baabac4e86cdb5358" title="USBStdGetStatusHandler" alt="" coords="1060,693,1263,723"><area shape="rect" href="usb__device_8h.html#23b85d487e9d3b37a4580138baf6b097" title="USBStdSetCfgHandler" alt="" coords="1069,480,1253,509"><area shape="rect" href="usb__otg_8h.html#df4bb848d4c77a2b5542dd3478bafa76" title="USBOTGDisableAltHnp" alt="" coords="1341,587,1528,616"><area shape="rect" href="usb__otg_8h.html#6ea42b055d88fc42421bd7cb9c120a4a" title="USBOTGDisableSupportHnp" alt="" coords="1321,640,1548,669"><area shape="rect" href="usb__otg_8h.html#a79b51ab15ce5d80d5e4e78298c9d4c6" title="USBOTGEnableAltHnp" alt="" coords="1343,693,1527,723"><area shape="rect" href="usb__otg_8h.html#4055c7be50b72d3312c60ccce3464782" title="USBOTGEnableHnp" alt="" coords="1352,480,1517,509"><area shape="rect" href="usb__otg_8h.html#37a367b19b4b2f62c2dc0064f61d13fb" title="USBOTGEnableSupportHnp" alt="" coords="1323,533,1547,563"><area shape="rect" href="usb__device_8h.html#e69da16b1f966a62cdd1831df5561cbf" title="This function is called when the device becomes initialized, which occurs after the..." alt="" coords="1375,373,1495,403"><area shape="rect" href="usb__device_8h.html#25c6b82e249f563f00732a7e242c4267" title="USBEnableEndpoint" alt="" coords="1597,373,1765,403"><area shape="rect" href="usb__device_8h.html#1901fa27385226b6cdad1f5b091e5374" title="USBConfigureEndpoint" alt="" coords="1815,373,2004,403"><area shape="rect" href="usb__device_8h.html#24bc7f902cfd3ef505708c71099ca32a" title="Section: CALLBACKS." alt="" coords="540,323,681,352"><area shape="rect" href="usb__device_8h.html#cb07fd7b59801b89093d5f5a375a1bb1" title="This function is called when the USB interrupt bit is set In this example the interrupt..." alt="" coords="500,376,721,405"></map>
</div>

</div>
</div><p>
<a class="anchor" name="25c6b82e249f563f00732a7e242c4267"></a><!-- doxytag: member="usb_device.c::USBEnableEndpoint" ref="25c6b82e249f563f00732a7e242c4267" args="(BYTE ep, BYTE options)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBEnableEndpoint           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td>
          <td class="paramname"> <em>ep</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td>
          <td class="paramname"> <em>options</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01901"></a>01901 {
<a name="l01902"></a>01902     <span class="comment">//Set the options to the appropriate endpoint control register</span>
<a name="l01903"></a>01903     <span class="comment">//*((unsigned char*)(&amp;U1EP0+ep)) = options;</span>
<a name="l01904"></a>01904     {
<a name="l01905"></a>01905 <span class="preprocessor">        #if defined(__C32__)</span>
<a name="l01906"></a>01906 <span class="preprocessor"></span>                        <a class="code" href="_generic_type_defs_8h.html#d342ac907eb044443153a22f964bf0af">DWORD</a>* p;    <span class="comment">// see "Bugfix for USBEnableEndPoint() in usd_device.c" -- http://forum.microchip.com/tm.aspx?m=384398</span>
<a name="l01907"></a>01907             p = (<a class="code" href="_generic_type_defs_8h.html#d342ac907eb044443153a22f964bf0af">DWORD</a>*)(&amp;<a class="code" href="usb__hal__pic18_8h.html#ab50b71574d46f330f4f32d8897d6899">U1EP0</a>+(4*ep));
<a name="l01908"></a>01908 <span class="preprocessor">        #else</span>
<a name="l01909"></a>01909 <span class="preprocessor"></span>                        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* p;    <span class="comment">// see "Bugfix for USBEnableEndPoint() in usd_device.c" -- http://forum.microchip.com/tm.aspx?m=384398</span>
<a name="l01910"></a>01910             p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)(&amp;<a class="code" href="usb__hal__pic18_8h.html#ab50b71574d46f330f4f32d8897d6899">U1EP0</a>+ep);
<a name="l01911"></a>01911 <span class="preprocessor">        #endif</span>
<a name="l01912"></a>01912 <span class="preprocessor"></span>        *p = options;
<a name="l01913"></a>01913     }
<a name="l01914"></a>01914 
<a name="l01915"></a>01915     <span class="keywordflow">if</span>(options &amp; USB_OUT_ENABLED)
<a name="l01916"></a>01916     {
<a name="l01917"></a>01917         <a class="code" href="usb__device_8h.html#1901fa27385226b6cdad1f5b091e5374">USBConfigureEndpoint</a>(ep,0);
<a name="l01918"></a>01918     }
<a name="l01919"></a>01919     <span class="keywordflow">if</span>(options &amp; USB_IN_ENABLED)
<a name="l01920"></a>01920     {
<a name="l01921"></a>01921         <a class="code" href="usb__device_8h.html#1901fa27385226b6cdad1f5b091e5374">USBConfigureEndpoint</a>(ep,1);
<a name="l01922"></a>01922     }
<a name="l01923"></a>01923 }
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_25c6b82e249f563f00732a7e242c4267_cgraph.png" border="0" usemap="#usb__device_8c_25c6b82e249f563f00732a7e242c4267_cgraph_map" alt=""></center>
<map name="usb__device_8c_25c6b82e249f563f00732a7e242c4267_cgraph_map">
<area shape="rect" href="usb__device_8h.html#1901fa27385226b6cdad1f5b091e5374" title="USBConfigureEndpoint" alt="" coords="223,5,412,35"></map>
</div>

</div>
</div><p>
<a class="anchor" name="5fff309db0c489c108b02e5b0c665f3a"></a><!-- doxytag: member="usb_device.c::USBPrepareForNextSetupTrf" ref="5fff309db0c489c108b02e5b0c665f3a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBPrepareForNextSetupTrf           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l00988"></a>00988 {
<a name="l00989"></a>00989     <span class="comment">/********************************************************************</span>
<a name="l00990"></a>00990 <span class="comment">    Bug Fix: Feb 26, 2007 v2.1</span>
<a name="l00991"></a>00991 <span class="comment">    *********************************************************************</span>
<a name="l00992"></a>00992 <span class="comment">    Facts:</span>
<a name="l00993"></a>00993 <span class="comment">    A Setup Packet should never be stalled. (USB 2.0 Section 8.5.3)</span>
<a name="l00994"></a>00994 <span class="comment">    If a Setup PID is detected by the SIE, the DTSEN setting is ignored.</span>
<a name="l00995"></a>00995 <span class="comment">    This causes a problem at the end of a control write transaction.</span>
<a name="l00996"></a>00996 <span class="comment">    In USBCtrlEPServiceComplete(), during a control write (Host to Device),</span>
<a name="l00997"></a>00997 <span class="comment">    the EP0_OUT is setup to write any data to the CtrlTrfData buffer.</span>
<a name="l00998"></a>00998 <span class="comment">    If &lt;SETUP[0]&gt;&lt;IN[1]&gt; is completed and USBCtrlTrfInHandler() is not</span>
<a name="l00999"></a>00999 <span class="comment">    called before the next &lt;SETUP[0]&gt; is received, then the latest Setup</span>
<a name="l01000"></a>01000 <span class="comment">    data will be written to the CtrlTrfData buffer instead of the SetupPkt</span>
<a name="l01001"></a>01001 <span class="comment">    buffer.</span>
<a name="l01002"></a>01002 <span class="comment"></span>
<a name="l01003"></a>01003 <span class="comment">    If USBCtrlTrfInHandler() was called before the latest &lt;SETUP[0]&gt; is</span>
<a name="l01004"></a>01004 <span class="comment">    received, then there would be no problem,</span>
<a name="l01005"></a>01005 <span class="comment">    because USBPrepareForNextSetupTrf() would have been called and updated</span>
<a name="l01006"></a>01006 <span class="comment">    ep0Bo.ADR to point to the SetupPkt buffer.</span>
<a name="l01007"></a>01007 <span class="comment"></span>
<a name="l01008"></a>01008 <span class="comment">    Work around:</span>
<a name="l01009"></a>01009 <span class="comment">    Check for the problem as described above and copy the Setup data from</span>
<a name="l01010"></a>01010 <span class="comment">    CtrlTrfData to SetupPkt.</span>
<a name="l01011"></a>01011 <span class="comment">    ********************************************************************/</span>
<a name="l01012"></a>01012     <span class="keywordflow">if</span>((<a class="code" href="usb__device_8c.html#98752e9a61499b8a4998c0c3437cf73e">controlTransferState</a> == <a class="code" href="usb__device_8h.html#4c889997921d3278ecae3443e0ee97e1">CTRL_TRF_RX</a>) &amp;&amp;
<a name="l01013"></a>01013        (<a class="code" href="usb__hal__pic18_8h.html#1147bb6143eebc90a11cb06ff1beed80">USBPacketDisable</a> == 1) &amp;&amp;
<a name="l01014"></a>01014        (<a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> == <span class="keyword">sizeof</span>(<a class="code" href="usb__device_8h.html#15cc7fbb1fa621148405d99bcd66092b">CTRL_TRF_SETUP</a>)) &amp;&amp;
<a name="l01015"></a>01015        (<a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#8dc1a0d3225984a18c2d6b52dab33026">PID</a> == <a class="code" href="usb__device_8h.html#2c2773a05dd47f8a2432f1c2aa211ee3">SETUP_TOKEN</a>) &amp;&amp;
<a name="l01016"></a>01016        (<a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#e624ce5bfa8abc3e45197f13a3df1dba">UOWN</a> == 0))
<a name="l01017"></a>01017     {
<a name="l01018"></a>01018         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> setup_cnt;
<a name="l01019"></a>01019 
<a name="l01020"></a>01020         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022         <span class="comment">// The Setup data was written to the CtrlTrfData buffer, must copy</span>
<a name="l01023"></a>01023         <span class="comment">// it back to the SetupPkt buffer so that it can be processed correctly</span>
<a name="l01024"></a>01024         <span class="comment">// by USBCtrlTrfSetupHandler().</span>
<a name="l01025"></a>01025         <span class="keywordflow">for</span>(setup_cnt = 0; setup_cnt &lt; <span class="keyword">sizeof</span>(<a class="code" href="usb__device_8h.html#15cc7fbb1fa621148405d99bcd66092b">CTRL_TRF_SETUP</a>); setup_cnt++)
<a name="l01026"></a>01026         {
<a name="l01027"></a>01027             *(((<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>)+setup_cnt) = *(((<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;<a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>)+setup_cnt);
<a name="l01028"></a>01028         }<span class="comment">//end for</span>
<a name="l01029"></a>01029     }
<a name="l01030"></a>01030     <span class="comment">/* End v3b fix */</span>
<a name="l01031"></a>01031     <span class="keywordflow">else</span>
<a name="l01032"></a>01032     {
<a name="l01033"></a>01033         <a class="code" href="usb__device_8c.html#98752e9a61499b8a4998c0c3437cf73e">controlTransferState</a> = <a class="code" href="usb__device_8h.html#e9a70c9f0037f259d10a26e476f52862">WAIT_SETUP</a>;
<a name="l01034"></a>01034         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>;      <span class="comment">// Defined in usb_config.h</span>
<a name="l01035"></a>01035         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>);
<a name="l01036"></a>01036 
<a name="l01037"></a>01037         <span class="comment">/********************************************************************</span>
<a name="l01038"></a>01038 <span class="comment">        Bug Fix: Feb 26, 2007 v2.1 (#F1)</span>
<a name="l01039"></a>01039 <span class="comment">        *********************************************************************</span>
<a name="l01040"></a>01040 <span class="comment">        In the original firmware, if an OUT token is sent by the host</span>
<a name="l01041"></a>01041 <span class="comment">        before a SETUP token is sent, the firmware would respond with an ACK.</span>
<a name="l01042"></a>01042 <span class="comment">        This is not a correct response, the firmware should have sent a STALL.</span>
<a name="l01043"></a>01043 <span class="comment">        This is a minor non-compliance since a compliant host should not</span>
<a name="l01044"></a>01044 <span class="comment">        send an OUT before sending a SETUP token. The fix allows a SETUP</span>
<a name="l01045"></a>01045 <span class="comment">        transaction to be accepted while stalling OUT transactions.</span>
<a name="l01046"></a>01046 <span class="comment">        ********************************************************************/</span>
<a name="l01047"></a>01047         <span class="comment">//ep0Bo.Stat.Val = _USIE|_DAT0|_DTSEN;        // Removed</span>
<a name="l01048"></a>01048         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#6201ae0510cbe621aa0ae8f7e1f16653">_DAT0</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>|<a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>;  <span class="comment">//Added #F1</span>
<a name="l01049"></a>01049 
<a name="l01050"></a>01050         <span class="comment">/********************************************************************</span>
<a name="l01051"></a>01051 <span class="comment">        Bug Fix: Feb 26, 2007 v2.1 (#F3)</span>
<a name="l01052"></a>01052 <span class="comment">        *********************************************************************</span>
<a name="l01053"></a>01053 <span class="comment">        In the original firmware, if an IN token is sent by the host</span>
<a name="l01054"></a>01054 <span class="comment">        before a SETUP token is sent, the firmware would respond with an ACK.</span>
<a name="l01055"></a>01055 <span class="comment">        This is not a correct response, the firmware should have sent a STALL.</span>
<a name="l01056"></a>01056 <span class="comment">        This is a minor non-compliance since a compliant host should not</span>
<a name="l01057"></a>01057 <span class="comment">        send an IN before sending a SETUP token.</span>
<a name="l01058"></a>01058 <span class="comment"></span>
<a name="l01059"></a>01059 <span class="comment">        Comment why this fix (#F3) is interfering with fix (#AF1).</span>
<a name="l01060"></a>01060 <span class="comment">        ********************************************************************/</span>
<a name="l01061"></a>01061         <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#91d20addc5cc0306cc07eeef1ced0c18">_UCPU</a>;             <span class="comment">// Should be removed</span>
<a name="l01062"></a>01062 
<a name="l01063"></a>01063         {
<a name="l01064"></a>01064             <a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>* p;
<a name="l01065"></a>01065 
<a name="l01066"></a>01066             p = (<a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)(((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0])^<a class="code" href="usb__device_8h.html#96cb2e1d960d598d505a6dfef7da21d6">USB_NEXT_EP0_IN_PING_PONG</a>);
<a name="l01067"></a>01067             p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#91d20addc5cc0306cc07eeef1ced0c18">_UCPU</a>;
<a name="l01068"></a>01068         }
<a name="l01069"></a>01069 
<a name="l01070"></a>01070         <span class="comment">//ep0Bi.Stat.Val = _USIE|_BSTALL;   // Should be added #F3</span>
<a name="l01071"></a>01071     }
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <span class="comment">//if someone is still expecting data from the control transfer</span>
<a name="l01074"></a>01074     <span class="comment">//  then make sure to terminate that request and let them know that</span>
<a name="l01075"></a>01075     <span class="comment">//  they are done</span>
<a name="l01076"></a>01076     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].info.bits.busy == 1)
<a name="l01077"></a>01077     {
<a name="l01078"></a>01078         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].pFunc != <a class="code" href="_generic_type_defs_8h.html#070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01079"></a>01079         {
<a name="l01080"></a>01080             <a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].pFunc();
<a name="l01081"></a>01081         }
<a name="l01082"></a>01082         <a class="code" href="usb__device_8h.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[0].info.bits.busy = 0;
<a name="l01083"></a>01083     }
<a name="l01084"></a>01084 
<a name="l01085"></a>01085 }<span class="comment">//end USBPrepareForNextSetupTrf</span>
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="9c20d0ce9a00250250ff518d2705a5e1"></a><!-- doxytag: member="usb_device.c::USBStallEndpoint" ref="9c20d0ce9a00250250ff518d2705a5e1" args="(BYTE ep, BYTE dir)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBStallEndpoint           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td>
          <td class="paramname"> <em>ep</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td>
          <td class="paramname"> <em>dir</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01943"></a>01943 {
<a name="l01944"></a>01944     <a class="code" href="union_____b_d_t.html">BDT_ENTRY</a> *p;
<a name="l01945"></a>01945 
<a name="l01946"></a>01946     <span class="keywordflow">if</span>(ep == 0)
<a name="l01947"></a>01947     {
<a name="l01948"></a>01948         <span class="comment">/*</span>
<a name="l01949"></a>01949 <span class="comment">         * If no one knows how to service this request then stall.</span>
<a name="l01950"></a>01950 <span class="comment">         * Must also prepare EP0 to receive the next SETUP transaction.</span>
<a name="l01951"></a>01951 <span class="comment">         */</span>
<a name="l01952"></a>01952         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#c86e1ab5e4354b7aeae00e2ba948c2f4">CNT</a> = <a class="code" href="usb__config_8h.html#e0068b787dd02f5b2515756b2a0b14a4" title="DEFINITIONS.">USB_EP0_BUFF_SIZE</a>;
<a name="l01953"></a>01953         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#064cbad208599c198bc701ddce14d590">ADR</a> = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(&amp;<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>);
<a name="l01954"></a>01954 
<a name="l01955"></a>01955         <span class="comment">/* v2b fix */</span>
<a name="l01956"></a>01956         <a class="code" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#6201ae0510cbe621aa0ae8f7e1f16653">_DAT0</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>|<a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>;
<a name="l01957"></a>01957         <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>; 
<a name="l01958"></a>01958     }
<a name="l01959"></a>01959     <span class="keywordflow">else</span>
<a name="l01960"></a>01960     {
<a name="l01961"></a>01961         p = (<a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)(&amp;BDT[<a class="code" href="usb__device_8h.html#4818072abcb3ee443c6598eed60ab675">EP</a>(ep,dir,0)]);
<a name="l01962"></a>01962         p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> |= <a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a> | <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>;
<a name="l01963"></a>01963     
<a name="l01964"></a>01964         <span class="comment">//If the device is in FULL or ALL_BUT_EP0 ping pong modes</span>
<a name="l01965"></a>01965         <span class="comment">//then stall that entry as well</span>
<a name="l01966"></a>01966 <span class="preprocessor">        #if (USB_PING_PONG_MODE == USB_PING_PONG__FULL_PING_PONG) || \</span>
<a name="l01967"></a>01967 <span class="preprocessor">            (USB_PING_PONG_MODE == USB_PING_PONG__ALL_BUT_EP0)</span>
<a name="l01968"></a>01968 <span class="preprocessor"></span>    
<a name="l01969"></a>01969         p = (<a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)(&amp;BDT[<a class="code" href="usb__device_8h.html#4818072abcb3ee443c6598eed60ab675">EP</a>(ep,dir,1)]);
<a name="l01970"></a>01970         p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> |= <a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a> | <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>;
<a name="l01971"></a>01971 <span class="preprocessor">        #endif</span>
<a name="l01972"></a>01972 <span class="preprocessor"></span>    }
<a name="l01973"></a>01973 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="f7fca92a339183ae8f268bb8c3ca4e7e"></a><!-- doxytag: member="usb_device.c::USBStallHandler" ref="f7fca92a339183ae8f268bb8c3ca4e7e" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBStallHandler           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l00594"></a>00594 {
<a name="l00595"></a>00595     <span class="comment">/*</span>
<a name="l00596"></a>00596 <span class="comment">     * Does not really have to do anything here,</span>
<a name="l00597"></a>00597 <span class="comment">     * even for the control endpoint.</span>
<a name="l00598"></a>00598 <span class="comment">     * All BDs of Endpoint 0 are owned by SIE right now,</span>
<a name="l00599"></a>00599 <span class="comment">     * but once a Setup Transaction is received, the ownership</span>
<a name="l00600"></a>00600 <span class="comment">     * for EP0_OUT will be returned to CPU.</span>
<a name="l00601"></a>00601 <span class="comment">     * When the Setup Transaction is serviced, the ownership</span>
<a name="l00602"></a>00602 <span class="comment">     * for EP0_IN will then be forced back to CPU by firmware.</span>
<a name="l00603"></a>00603 <span class="comment">     */</span>
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="comment">/* v2b fix */</span>
<a name="l00606"></a>00606     <span class="keywordflow">if</span>(<a class="code" href="usb__hal__pic18_8h.html#e55885b97e36c687e238e145afa1b173">U1EP0bits</a>.EPSTALL == 1)
<a name="l00607"></a>00607     {
<a name="l00608"></a>00608         <span class="comment">// UOWN - if 0, owned by CPU, if 1, owned by SIE</span>
<a name="l00609"></a>00609         <span class="keywordflow">if</span>((<a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> == <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>) &amp;&amp; (<a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[0]-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> == (<a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>)))
<a name="l00610"></a>00610         {
<a name="l00611"></a>00611             <span class="comment">// Set ep0Bo to stall also</span>
<a name="l00612"></a>00612             <a class="code" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#6201ae0510cbe621aa0ae8f7e1f16653">_DAT0</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>|<a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>;
<a name="l00613"></a>00613         }<span class="comment">//end if</span>
<a name="l00614"></a>00614         <a class="code" href="usb__hal__pic18_8h.html#e55885b97e36c687e238e145afa1b173">U1EP0bits</a>.EPSTALL = 0;               <span class="comment">// Clear stall status</span>
<a name="l00615"></a>00615     }<span class="comment">//end if</span>
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(<a class="code" href="usb__hal__pic18_8h.html#06ca20c194e1999dff8e546d466016bf">USBStallIFReg</a>,<a class="code" href="usb__hal__pic18_8h.html#18aedcfc6f572287f75f276dc841f3d0">USBStallIFBitNum</a>);
<a name="l00618"></a>00618 }
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_f7fca92a339183ae8f268bb8c3ca4e7e_cgraph.png" border="0" usemap="#usb__device_8c_f7fca92a339183ae8f268bb8c3ca4e7e_cgraph_map" alt=""></center>
<map name="usb__device_8c_f7fca92a339183ae8f268bb8c3ca4e7e_cgraph_map">
<area shape="rect" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc" title="USBClearInterruptFlag" alt="" coords="196,5,380,35"></map>
</div>

</div>
</div><p>
<a class="anchor" name="109b75c6ceba7a1ac93ac8653dae6405"></a><!-- doxytag: member="usb_device.c::USBStdFeatureReqHandler" ref="109b75c6ceba7a1ac93ac8653dae6405" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBStdFeatureReqHandler           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01169"></a>01169 {
<a name="l01170"></a>01170     <a class="code" href="union_____b_d_t.html">BDT_ENTRY</a> *p;
<a name="l01171"></a>01171 <span class="preprocessor">    #if defined(__C32__)</span>
<a name="l01172"></a>01172 <span class="preprocessor"></span>        <a class="code" href="_generic_type_defs_8h.html#d342ac907eb044443153a22f964bf0af">DWORD</a>* pUEP;
<a name="l01173"></a>01173 <span class="preprocessor">    #else</span>
<a name="l01174"></a>01174 <span class="preprocessor"></span>        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>* pUEP;      <span class="comment">// see "Bugfix for USBEnableEndPoint() in usd_device.c" -- http://forum.microchip.com/tm.aspx?m=384398       </span>
<a name="l01175"></a>01175 <span class="preprocessor">    #endif</span>
<a name="l01176"></a>01176 <span class="preprocessor"></span><span class="preprocessor">#ifdef  USB_SUPPORT_OTG</span>
<a name="l01177"></a>01177 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bFeature == <a class="code" href="usb__ch9_8h.html#b1eb008c2545555250224ffdd22e6ef7">OTG_FEATURE_B_HNP_ENABLE</a>)&amp;&amp;
<a name="l01178"></a>01178         (<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.Recipient == <a class="code" href="usb__device_8h.html#1a9b0df23abe28c1c15f71629d842eef">RCPT_DEV</a>))
<a name="l01179"></a>01179     {  
<a name="l01180"></a>01180         <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;
<a name="l01181"></a>01181         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bRequest == <a class="code" href="usb__device_8h.html#f8b97e67097fbf7d56c3dcac52fe679e">SET_FEATURE</a>)
<a name="l01182"></a>01182             <a class="code" href="usb__otg_8h.html#4055c7be50b72d3312c60ccce3464782">USBOTGEnableHnp</a>();
<a name="l01183"></a>01183         <span class="keywordflow">else</span>
<a name="l01184"></a>01184             <a class="code" href="usb__otg_8h.html#d078cd43132c6251de3865b19b8de4cb">USBOTGDisableHnp</a>();
<a name="l01185"></a>01185     }
<a name="l01186"></a>01186 
<a name="l01187"></a>01187     <span class="keywordflow">if</span> ((<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bFeature == <a class="code" href="usb__ch9_8h.html#c95e8be488ed9ca8ebf9541306fe070b">OTG_FEATURE_A_HNP_SUPPORT</a>)&amp;&amp;
<a name="l01188"></a>01188         (<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.Recipient == <a class="code" href="usb__device_8h.html#1a9b0df23abe28c1c15f71629d842eef">RCPT_DEV</a>))
<a name="l01189"></a>01189     {
<a name="l01190"></a>01190         <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;
<a name="l01191"></a>01191         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bRequest == <a class="code" href="usb__device_8h.html#f8b97e67097fbf7d56c3dcac52fe679e">SET_FEATURE</a>)
<a name="l01192"></a>01192             <a class="code" href="usb__otg_8h.html#37a367b19b4b2f62c2dc0064f61d13fb">USBOTGEnableSupportHnp</a>();
<a name="l01193"></a>01193         <span class="keywordflow">else</span>
<a name="l01194"></a>01194             <a class="code" href="usb__otg_8h.html#6ea42b055d88fc42421bd7cb9c120a4a">USBOTGDisableSupportHnp</a>();
<a name="l01195"></a>01195     }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197 
<a name="l01198"></a>01198     <span class="keywordflow">if</span> ((<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bFeature == <a class="code" href="usb__ch9_8h.html#4c05deae742762f3110366a7bb8bffc2">OTG_FEATURE_A_ALT_HNP_SUPPORT</a>)&amp;&amp;
<a name="l01199"></a>01199         (<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.Recipient == <a class="code" href="usb__device_8h.html#1a9b0df23abe28c1c15f71629d842eef">RCPT_DEV</a>))
<a name="l01200"></a>01200     {
<a name="l01201"></a>01201         <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;
<a name="l01202"></a>01202         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bRequest == <a class="code" href="usb__device_8h.html#f8b97e67097fbf7d56c3dcac52fe679e">SET_FEATURE</a>)
<a name="l01203"></a>01203             <a class="code" href="usb__otg_8h.html#a79b51ab15ce5d80d5e4e78298c9d4c6">USBOTGEnableAltHnp</a>();
<a name="l01204"></a>01204         <span class="keywordflow">else</span>
<a name="l01205"></a>01205             <a class="code" href="usb__otg_8h.html#df4bb848d4c77a2b5542dd3478bafa76">USBOTGDisableAltHnp</a>();
<a name="l01206"></a>01206     }
<a name="l01207"></a>01207 <span class="preprocessor">#endif    </span>
<a name="l01208"></a>01208 <span class="preprocessor"></span>    <span class="keywordflow">if</span>((<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bFeature == <a class="code" href="usb__device_8h.html#77fa7e6093059898a0849f02968fba1d">DEVICE_REMOTE_WAKEUP</a>)&amp;&amp;
<a name="l01209"></a>01209        (<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.Recipient == <a class="code" href="usb__device_8h.html#1a9b0df23abe28c1c15f71629d842eef">RCPT_DEV</a>))
<a name="l01210"></a>01210     {
<a name="l01211"></a>01211         <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;
<a name="l01212"></a>01212         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bRequest == <a class="code" href="usb__device_8h.html#f8b97e67097fbf7d56c3dcac52fe679e">SET_FEATURE</a>)
<a name="l01213"></a>01213             <a class="code" href="usb__device_8h.html#eada8d244f77e59054a0e399fc5e87cb">RemoteWakeup</a> = <a class="code" href="_generic_type_defs_8h.html#fbf708854fe02af8475a9ba02f3196cba82764c3079aea4e60c80e45befbb839">TRUE</a>;
<a name="l01214"></a>01214         <span class="keywordflow">else</span>
<a name="l01215"></a>01215             <a class="code" href="usb__device_8h.html#eada8d244f77e59054a0e399fc5e87cb">RemoteWakeup</a> = <a class="code" href="_generic_type_defs_8h.html#fbf708854fe02af8475a9ba02f3196cba1e095cc966dbecf6a0d8aad75348d1a">FALSE</a>;
<a name="l01216"></a>01216     }<span class="comment">//end if</span>
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     <span class="keywordflow">if</span>((<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bFeature == <a class="code" href="usb__device_8h.html#4d7a6aea8f3ed0b277c3b40fb5df77fc">ENDPOINT_HALT</a>)&amp;&amp;
<a name="l01219"></a>01219        (<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.Recipient == <a class="code" href="usb__device_8h.html#90e1170bed79595b52d4ae8f75276341">RCPT_EP</a>)&amp;&amp;
<a name="l01220"></a>01220        (<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.EPNum != 0))
<a name="l01221"></a>01221     {
<a name="l01222"></a>01222         <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;
<a name="l01223"></a>01223         <span class="comment">/* Must do address calculation here */</span>
<a name="l01224"></a>01224 
<a name="l01225"></a>01225         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.EPDir == 0)
<a name="l01226"></a>01226         {
<a name="l01227"></a>01227             p = (<a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)<a class="code" href="usb__device_8c.html#9777e7690b52368e534894b7c6c2bb18">pBDTEntryOut</a>[<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.EPNum];
<a name="l01228"></a>01228         }
<a name="l01229"></a>01229         <span class="keywordflow">else</span>
<a name="l01230"></a>01230         {
<a name="l01231"></a>01231             p = (<a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)<a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.EPNum];
<a name="l01232"></a>01232         }
<a name="l01233"></a>01233 
<a name="l01234"></a>01234                 <span class="comment">//if it was a SET_FEATURE request</span>
<a name="l01235"></a>01235         <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bRequest == <a class="code" href="usb__device_8h.html#f8b97e67097fbf7d56c3dcac52fe679e">SET_FEATURE</a>)
<a name="l01236"></a>01236         {
<a name="l01237"></a>01237                         <span class="comment">//Then STALL the endpoint</span>
<a name="l01238"></a>01238             p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>;
<a name="l01239"></a>01239         }
<a name="l01240"></a>01240         <span class="keywordflow">else</span>
<a name="l01241"></a>01241         {
<a name="l01242"></a>01242                         <span class="comment">//If it was not a SET_FEATURE</span>
<a name="l01243"></a>01243                         <span class="comment">//point to the appropriate UEP register</span>
<a name="l01244"></a>01244 <span class="preprocessor">            #if defined(__C32__)</span>
<a name="l01245"></a>01245 <span class="preprocessor"></span>                pUEP = (<a class="code" href="_generic_type_defs_8h.html#d342ac907eb044443153a22f964bf0af">DWORD</a>*)(&amp;<a class="code" href="usb__hal__pic18_8h.html#ab50b71574d46f330f4f32d8897d6899">U1EP0</a>);
<a name="l01246"></a>01246                 pUEP += (<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.EPNum*4);
<a name="l01247"></a>01247 <span class="preprocessor">            #else</span>
<a name="l01248"></a>01248 <span class="preprocessor"></span>                pUEP = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)(&amp;<a class="code" href="usb__hal__pic18_8h.html#ab50b71574d46f330f4f32d8897d6899">U1EP0</a>+<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.EPNum);     <span class="comment">// see "Bugfix for USBEnableEndPoint() in usd_device.c" -- http://forum.microchip.com/tm.aspx?m=384398</span>
<a name="l01249"></a>01249 <span class="preprocessor">            #endif</span>
<a name="l01250"></a>01250 <span class="preprocessor"></span>
<a name="l01251"></a>01251                         <span class="comment">//Clear the STALL bit in the UEP register</span>
<a name="l01252"></a>01252             *pUEP &amp;= ~<a class="code" href="usb__hal__pic18_8h.html#78f14921c90e506df875aeb7c3bbec61">UEP_STALL</a>;
<a name="l01253"></a>01253 
<a name="l01254"></a>01254             <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.EPDir == 1) <span class="comment">// IN</span>
<a name="l01255"></a>01255             {
<a name="l01256"></a>01256                                 <span class="comment">//If the endpoint is an IN endpoint then we</span>
<a name="l01257"></a>01257                                 <span class="comment">//  need to return it to the CPU and reset the</span>
<a name="l01258"></a>01258                                 <span class="comment">//  DTS bit so that the next transfer is correct</span>
<a name="l01259"></a>01259 <span class="preprocessor">                #if (USB_PING_PONG_MODE == USB_PING_PONG__ALL_BUT_EP0) || (USB_PING_PONG_MODE == USB_PING_PONG__FULL_PING_PONG)   </span>
<a name="l01260"></a>01260 <span class="preprocessor"></span>                    p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#91d20addc5cc0306cc07eeef1ced0c18">_UCPU</a>|<a class="code" href="usb__hal__pic18_8h.html#6201ae0510cbe621aa0ae8f7e1f16653">_DAT0</a>;
<a name="l01261"></a>01261                     <span class="comment">//toggle over the to the next buffer</span>
<a name="l01262"></a>01262                     ((<a class="code" href="union___b_y_t_e___v_a_l.html">BYTE_VAL</a>*)&amp;p)-&gt;Val ^= <a class="code" href="usb__device_8h.html#a2cefbc8edc3b0517679edfcfbde0130">USB_NEXT_PING_PONG</a>;
<a name="l01263"></a>01263                     p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#91d20addc5cc0306cc07eeef1ced0c18">_UCPU</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>;
<a name="l01264"></a>01264 <span class="preprocessor">                #else</span>
<a name="l01265"></a>01265 <span class="preprocessor"></span>                    p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#91d20addc5cc0306cc07eeef1ced0c18">_UCPU</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>;
<a name="l01266"></a>01266 <span class="preprocessor">                #endif</span>
<a name="l01267"></a>01267 <span class="preprocessor"></span>            }
<a name="l01268"></a>01268             <span class="keywordflow">else</span>
<a name="l01269"></a>01269             {
<a name="l01270"></a>01270                                 <span class="comment">//If the endpoint was an OUT endpoint then we</span>
<a name="l01271"></a>01271                                 <span class="comment">//  need to give control of the endpoint back to</span>
<a name="l01272"></a>01272                                 <span class="comment">//  the SIE so that the function driver can </span>
<a name="l01273"></a>01273                                 <span class="comment">//  receive the data as they expected.  Also need</span>
<a name="l01274"></a>01274                                 <span class="comment">//  to set the DTS bit so the next packet will be</span>
<a name="l01275"></a>01275                                 <span class="comment">//  correct</span>
<a name="l01276"></a>01276 <span class="preprocessor">                #if (USB_PING_PONG_MODE == USB_PING_PONG__ALL_BUT_EP0) || (USB_PING_PONG_MODE == USB_PING_PONG__FULL_PING_PONG)   </span>
<a name="l01277"></a>01277 <span class="preprocessor"></span>                    p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#6201ae0510cbe621aa0ae8f7e1f16653">_DAT0</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l01278"></a>01278                     <span class="comment">//toggle over the to the next buffer</span>
<a name="l01279"></a>01279                     ((<a class="code" href="union___b_y_t_e___v_a_l.html">BYTE_VAL</a>*)&amp;p)-&gt;Val ^= <a class="code" href="usb__device_8h.html#a2cefbc8edc3b0517679edfcfbde0130">USB_NEXT_PING_PONG</a>;
<a name="l01280"></a>01280                     p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l01281"></a>01281 <span class="preprocessor">                #else</span>
<a name="l01282"></a>01282 <span class="preprocessor"></span>                    p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> = <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a>|<a class="code" href="usb__hal__pic18_8h.html#bf201720e03f93584546460e16b34a47">_DAT1</a>|<a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l01283"></a>01283 <span class="preprocessor">                #endif</span>
<a name="l01284"></a>01284 <span class="preprocessor"></span>
<a name="l01285"></a>01285             }
<a name="l01286"></a>01286         }<span class="comment">//end if</span>
<a name="l01287"></a>01287 
<a name="l01288"></a>01288     }<span class="comment">//end if</span>
<a name="l01289"></a>01289 }<span class="comment">//end USBStdFeatureReqHandler</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_109b75c6ceba7a1ac93ac8653dae6405_cgraph.png" border="0" usemap="#usb__device_8c_109b75c6ceba7a1ac93ac8653dae6405_cgraph_map" alt=""></center>
<map name="usb__device_8c_109b75c6ceba7a1ac93ac8653dae6405_cgraph_map">
<area shape="rect" href="usb__otg_8h.html#df4bb848d4c77a2b5542dd3478bafa76" title="USBOTGDisableAltHnp" alt="" coords="296,5,483,35"><area shape="rect" href="usb__otg_8h.html#d078cd43132c6251de3865b19b8de4cb" title="USBOTGDisableHnp" alt="" coords="304,59,475,88"><area shape="rect" href="usb__otg_8h.html#6ea42b055d88fc42421bd7cb9c120a4a" title="USBOTGDisableSupportHnp" alt="" coords="276,112,503,141"><area shape="rect" href="usb__otg_8h.html#a79b51ab15ce5d80d5e4e78298c9d4c6" title="USBOTGEnableAltHnp" alt="" coords="297,165,481,195"><area shape="rect" href="usb__otg_8h.html#4055c7be50b72d3312c60ccce3464782" title="USBOTGEnableHnp" alt="" coords="307,219,472,248"><area shape="rect" href="usb__otg_8h.html#37a367b19b4b2f62c2dc0064f61d13fb" title="USBOTGEnableSupportHnp" alt="" coords="277,272,501,301"></map>
</div>

</div>
</div><p>
<a class="anchor" name="05d1ee4a1e4a8c8af6fb4816eba0a591"></a><!-- doxytag: member="usb_device.c::USBStdGetDscHandler" ref="05d1ee4a1e4a8c8af6fb4816eba0a591" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBStdGetDscHandler           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01308"></a>01308 {
<a name="l01309"></a>01309     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bmRequestType == 0x80)
<a name="l01310"></a>01310     {
<a name="l01311"></a>01311         <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.Val = <a class="code" href="usb__device_8h.html#e9faaf3d10d03ed8f3406f7dc570701c">USB_INPIPES_ROM</a> | <a class="code" href="usb__device_8h.html#95606a566ae8ae12f5d35de794b6d42e">USB_INPIPES_BUSY</a> | <a class="code" href="usb__device_8h.html#f1354ffaf8020c4a0d7b7f861afc5ded">USB_INPIPES_INCLUDE_ZERO</a>;
<a name="l01312"></a>01312 
<a name="l01313"></a>01313         <span class="keywordflow">switch</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bDescriptorType)
<a name="l01314"></a>01314         {
<a name="l01315"></a>01315             <span class="keywordflow">case</span> <a class="code" href="usb__ch9_8h.html#c6d0566773ed4549fe1a7a932e6c46de">USB_DESCRIPTOR_DEVICE</a>:
<a name="l01316"></a>01316 <span class="preprocessor">                #if !defined(USB_USER_DEVICE_DESCRIPTOR)</span>
<a name="l01317"></a>01317 <span class="preprocessor"></span>                    <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRom = (<a class="code" href="_compiler_8h.html#408c4c066164afa1b6aa3f804c3d3528">ROM</a> <a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;<a class="code" href="usb__device_8h.html#0043fcf8534afb25f3b9aea047aef1ba" title="INCLUDES.">device_dsc</a>;
<a name="l01318"></a>01318 <span class="preprocessor">                #else</span>
<a name="l01319"></a>01319 <span class="preprocessor"></span>                    <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRom = (<a class="code" href="_compiler_8h.html#408c4c066164afa1b6aa3f804c3d3528">ROM</a> <a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__config_8h.html#4a2ad5cd1344d606474a8d2d0309248a">USB_USER_DEVICE_DESCRIPTOR</a>;
<a name="l01320"></a>01320 <span class="preprocessor">                #endif</span>
<a name="l01321"></a>01321 <span class="preprocessor"></span>                <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.Val = <span class="keyword">sizeof</span>(<a class="code" href="usb__device_8h.html#0043fcf8534afb25f3b9aea047aef1ba" title="INCLUDES.">device_dsc</a>);
<a name="l01322"></a>01322                 <span class="keywordflow">break</span>;
<a name="l01323"></a>01323             <span class="keywordflow">case</span> <a class="code" href="usb__ch9_8h.html#a17b365c4eb8bd2f6a4d4e4fb5f881c7">USB_DESCRIPTOR_CONFIGURATION</a>:
<a name="l01324"></a>01324 <span class="preprocessor">                #if !defined(USB_USER_CONFIG_DESCRIPTOR)</span>
<a name="l01325"></a>01325 <span class="preprocessor"></span>                    <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRom = *(<a class="code" href="usb__device_8h.html#6cef2d16780d8287c7c9719af33cdab0">USB_CD_Ptr</a>+<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bDscIndex);
<a name="l01326"></a>01326 <span class="preprocessor">                #else</span>
<a name="l01327"></a>01327 <span class="preprocessor"></span>                    <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRom = *(<a class="code" href="usb__config_8h.html#abb33b6a5818ec129dd4d5b5dcf20785">USB_USER_CONFIG_DESCRIPTOR</a>+<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bDscIndex);
<a name="l01328"></a>01328 <span class="preprocessor">                #endif</span>
<a name="l01329"></a>01329 <span class="preprocessor"></span>                <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.Val = *(<a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.wRom+1);                <span class="comment">// Set data count</span>
<a name="l01330"></a>01330                 <span class="keywordflow">break</span>;
<a name="l01331"></a>01331             <span class="keywordflow">case</span> <a class="code" href="usb__ch9_8h.html#bbad38caa1ca9c52f47adccd3a850aed">USB_DESCRIPTOR_STRING</a>:
<a name="l01332"></a>01332 <span class="preprocessor">                #if defined(USB_NUM_STRING_DESCRIPTORS)</span>
<a name="l01333"></a>01333 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bDscIndex&lt;USB_NUM_STRING_DESCRIPTORS)
<a name="l01334"></a>01334 <span class="preprocessor">                #else</span>
<a name="l01335"></a>01335 <span class="preprocessor"></span>                <span class="keywordflow">if</span>(1)
<a name="l01336"></a>01336 <span class="preprocessor">                #endif</span>
<a name="l01337"></a>01337 <span class="preprocessor"></span>                {
<a name="l01338"></a>01338                     <span class="comment">//Get a pointer to the String descriptor requested</span>
<a name="l01339"></a>01339                     <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRom = *(<a class="code" href="usb__device_8h.html#5fd678847473856bf6b261994bcc1814">USB_SD_Ptr</a>+<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bDscIndex);
<a name="l01340"></a>01340                     <span class="comment">// Set data count</span>
<a name="l01341"></a>01341                     <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.Val = *<a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRom;                    
<a name="l01342"></a>01342                 }
<a name="l01343"></a>01343                 <span class="keywordflow">else</span>
<a name="l01344"></a>01344                 {
<a name="l01345"></a>01345                     <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.Val = 0;
<a name="l01346"></a>01346                 }
<a name="l01347"></a>01347                 <span class="keywordflow">break</span>;
<a name="l01348"></a>01348             <span class="keywordflow">default</span>:
<a name="l01349"></a>01349                 <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.Val = 0;
<a name="l01350"></a>01350                 <span class="keywordflow">break</span>;
<a name="l01351"></a>01351         }<span class="comment">//end switch</span>
<a name="l01352"></a>01352     }<span class="comment">//end if</span>
<a name="l01353"></a>01353 }<span class="comment">//end USBStdGetDscHandler</span>
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="07599ba7765be64baabac4e86cdb5358"></a><!-- doxytag: member="usb_device.c::USBStdGetStatusHandler" ref="07599ba7765be64baabac4e86cdb5358" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBStdGetStatusHandler           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01371"></a>01371 {
<a name="l01372"></a>01372     <a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>[0] = 0;                 <span class="comment">// Initialize content</span>
<a name="l01373"></a>01373     <a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>[1] = 0;
<a name="l01374"></a>01374 
<a name="l01375"></a>01375     <span class="keywordflow">switch</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.Recipient)
<a name="l01376"></a>01376     {
<a name="l01377"></a>01377         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#1a9b0df23abe28c1c15f71629d842eef">RCPT_DEV</a>:
<a name="l01378"></a>01378             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;
<a name="l01379"></a>01379             <span class="comment">/*</span>
<a name="l01380"></a>01380 <span class="comment">             * [0]: bit0: Self-Powered Status [0] Bus-Powered [1] Self-Powered</span>
<a name="l01381"></a>01381 <span class="comment">             *      bit1: RemoteWakeup        [0] Disabled    [1] Enabled</span>
<a name="l01382"></a>01382 <span class="comment">             */</span>
<a name="l01383"></a>01383             <span class="keywordflow">if</span>(<a class="code" href="_hardware_profile_8h.html#54cca94d2a6aee7594ba7e0685298454">self_power</a> == 1) <span class="comment">// self_power is defined in HardwareProfile.h</span>
<a name="l01384"></a>01384             {
<a name="l01385"></a>01385                 <a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>[0]|=0x01;
<a name="l01386"></a>01386             }
<a name="l01387"></a>01387 
<a name="l01388"></a>01388             <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#eada8d244f77e59054a0e399fc5e87cb">RemoteWakeup</a> == <a class="code" href="_generic_type_defs_8h.html#fbf708854fe02af8475a9ba02f3196cba82764c3079aea4e60c80e45befbb839">TRUE</a>)
<a name="l01389"></a>01389             {
<a name="l01390"></a>01390                 <a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>[0]|=0x02;
<a name="l01391"></a>01391             }
<a name="l01392"></a>01392             <span class="keywordflow">break</span>;
<a name="l01393"></a>01393         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#34421f863b077bb1c5bd3df1f1502360">RCPT_INTF</a>:
<a name="l01394"></a>01394             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;     <span class="comment">// No data to update</span>
<a name="l01395"></a>01395             <span class="keywordflow">break</span>;
<a name="l01396"></a>01396         <span class="keywordflow">case</span> <a class="code" href="usb__device_8h.html#90e1170bed79595b52d4ae8f75276341">RCPT_EP</a>:
<a name="l01397"></a>01397             <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;
<a name="l01398"></a>01398             <span class="comment">/*</span>
<a name="l01399"></a>01399 <span class="comment">             * [0]: bit0: Halt Status [0] Not Halted [1] Halted</span>
<a name="l01400"></a>01400 <span class="comment">             */</span>
<a name="l01401"></a>01401             {
<a name="l01402"></a>01402                 <a class="code" href="union_____b_d_t.html">BDT_ENTRY</a> *p;
<a name="l01403"></a>01403 
<a name="l01404"></a>01404                 <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.EPDir == 0)
<a name="l01405"></a>01405                 {
<a name="l01406"></a>01406                     p = (<a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)<a class="code" href="usb__device_8c.html#9777e7690b52368e534894b7c6c2bb18">pBDTEntryOut</a>[<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.EPNum];
<a name="l01407"></a>01407                 }
<a name="l01408"></a>01408                 <span class="keywordflow">else</span>
<a name="l01409"></a>01409                 {
<a name="l01410"></a>01410                     p = (<a class="code" href="union_____b_d_t.html">BDT_ENTRY</a>*)<a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.EPNum];
<a name="l01411"></a>01411                 }
<a name="l01412"></a>01412 
<a name="l01413"></a>01413                 <span class="keywordflow">if</span>(p-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> &amp; <a class="code" href="usb__hal__pic18_8h.html#40e888bafdf8a9697e2c8f243271aa28">_BSTALL</a>)    <span class="comment">// Use _BSTALL as a bit mask</span>
<a name="l01414"></a>01414                     <a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>[0]=0x01;    <span class="comment">// Set bit0</span>
<a name="l01415"></a>01415                 <span class="keywordflow">break</span>;
<a name="l01416"></a>01416             }
<a name="l01417"></a>01417     }<span class="comment">//end switch</span>
<a name="l01418"></a>01418 
<a name="l01419"></a>01419     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy == 1)
<a name="l01420"></a>01420     {
<a name="l01421"></a>01421         <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].pSrc.bRam = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)&amp;<a class="code" href="usb__device_8h.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>;            <span class="comment">// Set Source</span>
<a name="l01422"></a>01422         <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.ctrl_trf_mem = <a class="code" href="usb__device_8h.html#835b0195046543ba63b1ca0928077ce6">_RAM</a>;               <span class="comment">// Set memory type</span>
<a name="l01423"></a>01423         <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].wCount.v[0] = 2;                         <span class="comment">// Set data count</span>
<a name="l01424"></a>01424     }<span class="comment">//end if(...)</span>
<a name="l01425"></a>01425 }<span class="comment">//end USBStdGetStatusHandler</span>
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="23b85d487e9d3b37a4580138baf6b097"></a><!-- doxytag: member="usb_device.c::USBStdSetCfgHandler" ref="23b85d487e9d3b37a4580138baf6b097" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBStdSetCfgHandler           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l01765"></a>01765 {
<a name="l01766"></a>01766     <span class="comment">// This will generate a zero length packet</span>
<a name="l01767"></a>01767     <a class="code" href="usb__device_8h.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[0].info.bits.busy = 1;            
<a name="l01768"></a>01768 
<a name="l01769"></a>01769     <span class="comment">//disable all endpoints except endpoint 0</span>
<a name="l01770"></a>01770     memset((<span class="keywordtype">void</span>*)&amp;<a class="code" href="usb__hal__pic18_8h.html#2a55ce547263257dd0a25360d3636aa6">U1EP1</a>,0x00,(<a class="code" href="usb__config_8h.html#215684a6b1233e6db94531eca25f4d89">USB_MAX_EP_NUMBER</a>-1));
<a name="l01771"></a>01771 
<a name="l01772"></a>01772     <span class="comment">//clear the alternate interface settings</span>
<a name="l01773"></a>01773     memset((<span class="keywordtype">void</span>*)&amp;<a class="code" href="usb__device_8c.html#ddb2a0fc77382ce058ef62d88874cf8e">USBAlternateInterface</a>,0x00,<a class="code" href="usb__config_8h.html#6d07c750ebf95e297c88c58672b4c187">USB_MAX_NUM_INT</a>);
<a name="l01774"></a>01774 
<a name="l01775"></a>01775     <span class="comment">//set the current configuration</span>
<a name="l01776"></a>01776     <a class="code" href="usb__device_8h.html#91adced4a63e99db6b4b72faa09e78c5">USBActiveConfiguration</a> = <a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bConfigurationValue;
<a name="l01777"></a>01777 
<a name="l01778"></a>01778     <span class="comment">//if the configuration value == 0</span>
<a name="l01779"></a>01779     <span class="keywordflow">if</span>(<a class="code" href="usb__device_8h.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>.bConfigurationValue == 0)
<a name="l01780"></a>01780     {
<a name="l01781"></a>01781         <span class="comment">//Go back to the addressed state</span>
<a name="l01782"></a>01782         <a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> = <a class="code" href="usb__device_8h.html#6bcec49c4751b6e53d47835eeca5651a">ADDRESS_STATE</a>;
<a name="l01783"></a>01783     }
<a name="l01784"></a>01784     <span class="keywordflow">else</span>
<a name="l01785"></a>01785     {
<a name="l01786"></a>01786         <span class="comment">//Otherwise go to the configured state</span>
<a name="l01787"></a>01787         <a class="code" href="usb__device_8h.html#c6e6520c8c73c4456ea7194acff5bb71" title="EXTERNS.">USBDeviceState</a> = <a class="code" href="usb__device_8h.html#2aba92e0aaf8ccae5d19fa4de46d0c8f">CONFIGURED_STATE</a>;
<a name="l01788"></a>01788         <span class="comment">//initialize the required endpoints</span>
<a name="l01789"></a>01789         <a class="code" href="usb__device_8h.html#ce09340ac39526684b42f2e102c13a86">USBInitEP</a>((<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="code" href="_compiler_8h.html#408c4c066164afa1b6aa3f804c3d3528">ROM</a>*)(<a class="code" href="usb__device_8h.html#6cef2d16780d8287c7c9719af33cdab0">USB_CD_Ptr</a>[<a class="code" href="usb__device_8h.html#91adced4a63e99db6b4b72faa09e78c5">USBActiveConfiguration</a>-1]));
<a name="l01790"></a>01790         <a class="code" href="usb__device_8h.html#e69da16b1f966a62cdd1831df5561cbf" title="This function is called when the device becomes initialized, which occurs after the...">USBCBInitEP</a>();
<a name="l01791"></a>01791 
<a name="l01792"></a>01792     }<span class="comment">//end if(SetupPkt.bConfigurationValue == 0)</span>
<a name="l01793"></a>01793 }<span class="comment">//end USBStdSetCfgHandler</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_23b85d487e9d3b37a4580138baf6b097_cgraph.png" border="0" usemap="#usb__device_8c_23b85d487e9d3b37a4580138baf6b097_cgraph_map" alt=""></center>
<map name="usb__device_8c_23b85d487e9d3b37a4580138baf6b097_cgraph_map">
<area shape="rect" href="usb__device_8h.html#e69da16b1f966a62cdd1831df5561cbf" title="This function is called when the device becomes initialized, which occurs after the..." alt="" coords="239,5,359,35"><area shape="rect" href="usb__device_8h.html#25c6b82e249f563f00732a7e242c4267" title="USBEnableEndpoint" alt="" coords="408,5,576,35"><area shape="rect" href="usb__device_8h.html#1901fa27385226b6cdad1f5b091e5374" title="USBConfigureEndpoint" alt="" coords="625,5,815,35"></map>
</div>

</div>
</div><p>
<a class="anchor" name="1e0966febda8e01d2e4e58ceb42dd46a"></a><!-- doxytag: member="usb_device.c::USBSuspend" ref="1e0966febda8e01d2e4e58ceb42dd46a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBSuspend           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l00637"></a>00637 {
<a name="l00638"></a>00638     <span class="comment">/*</span>
<a name="l00639"></a>00639 <span class="comment">     * NOTE: Do not clear UIRbits.ACTVIF here!</span>
<a name="l00640"></a>00640 <span class="comment">     * Reason:</span>
<a name="l00641"></a>00641 <span class="comment">     * ACTVIF is only generated once an IDLEIF has been generated.</span>
<a name="l00642"></a>00642 <span class="comment">     * This is a 1:1 ratio interrupt generation.</span>
<a name="l00643"></a>00643 <span class="comment">     * For every IDLEIF, there will be only one ACTVIF regardless of</span>
<a name="l00644"></a>00644 <span class="comment">     * the number of subsequent bus transitions.</span>
<a name="l00645"></a>00645 <span class="comment">     *</span>
<a name="l00646"></a>00646 <span class="comment">     * If the ACTIF is cleared here, a problem could occur when:</span>
<a name="l00647"></a>00647 <span class="comment">     * [       IDLE       ][bus activity -&gt;</span>
<a name="l00648"></a>00648 <span class="comment">     * &lt;--- 3 ms -----&gt;     ^</span>
<a name="l00649"></a>00649 <span class="comment">     *                ^     ACTVIF=1</span>
<a name="l00650"></a>00650 <span class="comment">     *                IDLEIF=1</span>
<a name="l00651"></a>00651 <span class="comment">     *  #           #           #           #   (#=Program polling flags)</span>
<a name="l00652"></a>00652 <span class="comment">     *                          ^</span>
<a name="l00653"></a>00653 <span class="comment">     *                          This polling loop will see both</span>
<a name="l00654"></a>00654 <span class="comment">     *                          IDLEIF=1 and ACTVIF=1.</span>
<a name="l00655"></a>00655 <span class="comment">     *                          However, the program services IDLEIF first</span>
<a name="l00656"></a>00656 <span class="comment">     *                          because ACTIVIE=0.</span>
<a name="l00657"></a>00657 <span class="comment">     *                          If this routine clears the only ACTIVIF,</span>
<a name="l00658"></a>00658 <span class="comment">     *                          then it can never get out of the suspend</span>
<a name="l00659"></a>00659 <span class="comment">     *                          mode.</span>
<a name="l00660"></a>00660 <span class="comment">     */</span>
<a name="l00661"></a>00661     <a class="code" href="usb__hal__pic18_8h.html#e3d8d210b042931cd6914386ae628a83">USBActivityIE</a> = 1;                     <span class="comment">// Enable bus activity interrupt</span>
<a name="l00662"></a>00662     <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(<a class="code" href="usb__hal__pic18_8h.html#31f387320cef0c78a8ffee918613433e">USBIdleIFReg</a>,<a class="code" href="usb__hal__pic18_8h.html#e231304475b5d55192b196d14403d36b">USBIdleIFBitNum</a>);
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 <span class="preprocessor">#if defined(__18CXX)</span>
<a name="l00665"></a>00665 <span class="preprocessor"></span>    <a class="code" href="usb__hal__pic18_8h.html#faa3ceb75dda55243c5cff809a52f497">U1CONbits</a>.SUSPND = 1;                   <span class="comment">// Put USB module in power conserve</span>
<a name="l00666"></a>00666                                             <span class="comment">// mode, SIE clock inactive</span>
<a name="l00667"></a>00667 <span class="preprocessor">#endif</span>
<a name="l00668"></a>00668 <span class="preprocessor"></span> 
<a name="l00669"></a>00669  
<a name="l00670"></a>00670     <span class="comment">/*</span>
<a name="l00671"></a>00671 <span class="comment">     * At this point the PIC can go into sleep,idle, or</span>
<a name="l00672"></a>00672 <span class="comment">     * switch to a slower clock, etc.  This should be done in the</span>
<a name="l00673"></a>00673 <span class="comment">     * USBCBSuspend() if necessary.</span>
<a name="l00674"></a>00674 <span class="comment">     */</span>
<a name="l00675"></a>00675     <a class="code" href="usb__device_8h.html#24bc7f902cfd3ef505708c71099ca32a" title="Section: CALLBACKS.">USBCBSuspend</a>();             <span class="comment">// Required callback, see usbcallbacks.c</span>
<a name="l00676"></a>00676 }
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_1e0966febda8e01d2e4e58ceb42dd46a_cgraph.png" border="0" usemap="#usb__device_8c_1e0966febda8e01d2e4e58ceb42dd46a_cgraph_map" alt=""></center>
<map name="usb__device_8c_1e0966febda8e01d2e4e58ceb42dd46a_cgraph_map">
<area shape="rect" href="usb__device_8h.html#24bc7f902cfd3ef505708c71099ca32a" title="Section: CALLBACKS." alt="" coords="196,5,337,35"><area shape="rect" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc" title="USBClearInterruptFlag" alt="" coords="175,59,359,88"></map>
</div>

</div>
</div><p>
<a class="anchor" name="a7a7d33cf7a6033e1d158538375e2be8"></a><!-- doxytag: member="usb_device.c::USBTransferOnePacket" ref="a7a7d33cf7a6033e1d158538375e2be8" args="(BYTE ep, BYTE dir, BYTE *data, BYTE len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_HANDLE USBTransferOnePacket           </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td>
          <td class="paramname"> <em>ep</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td>
          <td class="paramname"> <em>dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>&nbsp;</td>
          <td class="paramname"> <em>len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l02000"></a>02000 {
<a name="l02001"></a>02001     <a class="code" href="usb__device_8h.html#2607555f418d28086253a65d5e481131">USB_HANDLE</a> handle;
<a name="l02002"></a>02002 
<a name="l02003"></a>02003     <span class="comment">//If the direction is IN</span>
<a name="l02004"></a>02004     <span class="keywordflow">if</span>(dir != 0)
<a name="l02005"></a>02005     {
<a name="l02006"></a>02006         <span class="comment">//point to the IN BDT of the specified endpoint</span>
<a name="l02007"></a>02007         handle = <a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[ep];
<a name="l02008"></a>02008     }
<a name="l02009"></a>02009     <span class="keywordflow">else</span>
<a name="l02010"></a>02010     {
<a name="l02011"></a>02011         <span class="comment">//else point to the OUT BDT of the specified endpoint</span>
<a name="l02012"></a>02012         handle = <a class="code" href="usb__device_8c.html#9777e7690b52368e534894b7c6c2bb18">pBDTEntryOut</a>[ep];
<a name="l02013"></a>02013     }
<a name="l02014"></a>02014 
<a name="l02015"></a>02015     <span class="comment">//Toggle the DTS bit if required</span>
<a name="l02016"></a>02016 <span class="preprocessor">    #if (USB_PING_PONG_MODE == USB_PING_PONG__NO_PING_PONG)</span>
<a name="l02017"></a>02017 <span class="preprocessor"></span>        handle-&gt;<a class="code" href="union_____b_d_t.html#715c1ee88748758b9be1df3b8472a5de">STAT</a>.<a class="code" href="union___b_d___s_t_a_t.html#255f8200d51a824758f14ed1e98d6c19">Val</a> ^= <a class="code" href="usb__hal__pic18_8h.html#c156b3e561fc10a3e2c49d31363237d3">_DTSMASK</a>;
<a name="l02018"></a>02018 <span class="preprocessor">    #elif (USB_PING_PONG_MODE == USB_PING_PONG__EP0_OUT_ONLY)</span>
<a name="l02019"></a>02019 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(ep != 0)
<a name="l02020"></a>02020         {
<a name="l02021"></a>02021             handle-&gt;STAT.Val ^= <a class="code" href="usb__hal__pic18_8h.html#c156b3e561fc10a3e2c49d31363237d3">_DTSMASK</a>;
<a name="l02022"></a>02022         }
<a name="l02023"></a>02023 <span class="preprocessor">    #endif</span>
<a name="l02024"></a>02024 <span class="preprocessor"></span>
<a name="l02025"></a>02025     <span class="comment">//Set the data pointer, data length, and enable the endpoint</span>
<a name="l02026"></a>02026     handle-&gt;ADR = (<a class="code" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>*)<a class="code" href="usb__hal__pic18_8h.html#538c09054ebff41eab11f18e2ef432a0">ConvertToPhysicalAddress</a>(data);
<a name="l02027"></a>02027     handle-&gt;CNT = len;
<a name="l02028"></a>02028     handle-&gt;STAT.Val &amp;= <a class="code" href="usb__hal__pic18_8h.html#c156b3e561fc10a3e2c49d31363237d3">_DTSMASK</a>;
<a name="l02029"></a>02029     handle-&gt;STAT.Val |= <a class="code" href="usb__hal__pic18_8h.html#3ba0754d1a4f6af2ed19e391ef480363">_USIE</a> | <a class="code" href="usb__hal__pic18_8h.html#17ecac1936bf1a23194e1212b64d714c">_DTSEN</a>;
<a name="l02030"></a>02030 
<a name="l02031"></a>02031     <span class="comment">//Point to the next buffer for ping pong purposes.</span>
<a name="l02032"></a>02032     <span class="keywordflow">if</span>(dir != 0)
<a name="l02033"></a>02033     {
<a name="l02034"></a>02034         <span class="comment">//toggle over the to the next buffer for an IN endpoint</span>
<a name="l02035"></a>02035         ((<a class="code" href="union___b_y_t_e___v_a_l.html">BYTE_VAL</a>*)&amp;<a class="code" href="usb__device_8h.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[ep])-&gt;Val ^= <a class="code" href="usb__device_8h.html#a2cefbc8edc3b0517679edfcfbde0130">USB_NEXT_PING_PONG</a>;
<a name="l02036"></a>02036     }
<a name="l02037"></a>02037     <span class="keywordflow">else</span>
<a name="l02038"></a>02038     {
<a name="l02039"></a>02039         <span class="comment">//toggle over the to the next buffer for an OUT endpoint</span>
<a name="l02040"></a>02040         ((<a class="code" href="union___b_y_t_e___v_a_l.html">BYTE_VAL</a>*)&amp;<a class="code" href="usb__device_8c.html#9777e7690b52368e534894b7c6c2bb18">pBDTEntryOut</a>[ep])-&gt;Val ^= <a class="code" href="usb__device_8h.html#a2cefbc8edc3b0517679edfcfbde0130">USB_NEXT_PING_PONG</a>;
<a name="l02041"></a>02041     }
<a name="l02042"></a>02042     <span class="keywordflow">return</span> handle;
<a name="l02043"></a>02043 }
</pre></div>
<p>

</div>
</div><p>
<a class="anchor" name="9104bea8c7f5045558f6cc5721e7455f"></a><!-- doxytag: member="usb_device.c::USBWakeFromSuspend" ref="9104bea8c7f5045558f6cc5721e7455f" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USBWakeFromSuspend           </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname">          </td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
<div class="fragment"><pre class="fragment"><a name="l00694"></a>00694 {
<a name="l00695"></a>00695 <span class="preprocessor">    #if defined(__18CXX)</span>
<a name="l00696"></a>00696 <span class="preprocessor"></span>    <a class="code" href="usb__hal__pic18_8h.html#faa3ceb75dda55243c5cff809a52f497">U1CONbits</a>.SUSPND = 0;                   <span class="comment">// Bring USB module out of power conserve</span>
<a name="l00697"></a>00697                                             <span class="comment">// mode.</span>
<a name="l00698"></a>00698 <span class="preprocessor">    #endif</span>
<a name="l00699"></a>00699 <span class="preprocessor"></span>
<a name="l00700"></a>00700     <span class="comment">/*</span>
<a name="l00701"></a>00701 <span class="comment">     * If using clock switching, the place to restore the original</span>
<a name="l00702"></a>00702 <span class="comment">     * microcontroller core clock frequency is in the USBCBWakeFromSuspend() callback</span>
<a name="l00703"></a>00703 <span class="comment">     */</span>
<a name="l00704"></a>00704     <a class="code" href="usb__device_8h.html#cb07fd7b59801b89093d5f5a375a1bb1" title="This function is called when the USB interrupt bit is set In this example the interrupt...">USBCBWakeFromSuspend</a>(); <span class="comment">// Required callback, see usbcallbacks.c</span>
<a name="l00705"></a>00705 
<a name="l00706"></a>00706     <a class="code" href="usb__hal__pic18_8h.html#e3d8d210b042931cd6914386ae628a83">USBActivityIE</a> = 0;
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <span class="comment">/********************************************************************</span>
<a name="l00709"></a>00709 <span class="comment">    Bug Fix: Feb 26, 2007 v2.1</span>
<a name="l00710"></a>00710 <span class="comment">    *********************************************************************</span>
<a name="l00711"></a>00711 <span class="comment">    The ACTVIF bit cannot be cleared immediately after the USB module wakes</span>
<a name="l00712"></a>00712 <span class="comment">    up from Suspend or while the USB module is suspended. A few clock cycles</span>
<a name="l00713"></a>00713 <span class="comment">    are required to synchronize the internal hardware state machine before</span>
<a name="l00714"></a>00714 <span class="comment">    the ACTIVIF bit can be cleared by firmware. Clearing the ACTVIF bit</span>
<a name="l00715"></a>00715 <span class="comment">    before the internal hardware is synchronized may not have an effect on</span>
<a name="l00716"></a>00716 <span class="comment">    the value of ACTVIF. Additonally, if the USB module uses the clock from</span>
<a name="l00717"></a>00717 <span class="comment">    the 96 MHz PLL source, then after clearing the SUSPND bit, the USB</span>
<a name="l00718"></a>00718 <span class="comment">    module may not be immediately operational while waiting for the 96 MHz</span>
<a name="l00719"></a>00719 <span class="comment">    PLL to lock.</span>
<a name="l00720"></a>00720 <span class="comment">    ********************************************************************/</span>
<a name="l00721"></a>00721 
<a name="l00722"></a>00722     <span class="comment">// UIRbits.ACTVIF = 0;                      // Removed</span>
<a name="l00723"></a>00723 <span class="preprocessor">    #if defined(__18CXX)</span>
<a name="l00724"></a>00724 <span class="preprocessor"></span>    <span class="keywordflow">while</span>(<a class="code" href="usb__hal__pic18_8h.html#8f7bffd17b97ace69f56b1ea4c12494d">USBActivityIF</a>)
<a name="l00725"></a>00725 <span class="preprocessor">    #endif</span>
<a name="l00726"></a>00726 <span class="preprocessor"></span>    {
<a name="l00727"></a>00727         <a class="code" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc">USBClearInterruptFlag</a>(<a class="code" href="usb__hal__pic18_8h.html#37b135c121927e6ab18faa13beb11962">USBActivityIFReg</a>,<a class="code" href="usb__hal__pic18_8h.html#74bc2ce00ddc8122a0a2f7af76e721d0">USBActivityIFBitNum</a>);
<a name="l00728"></a>00728     }  <span class="comment">// Added</span>
<a name="l00729"></a>00729 
<a name="l00730"></a>00730 }<span class="comment">//end USBWakeFromSuspend</span>
</pre></div>
<p>

<p>
<div class="dynheader">
Voici le graphe d'appel pour cette fonction :</div>
<div class="dynsection">
<p><center><img src="usb__device_8c_9104bea8c7f5045558f6cc5721e7455f_cgraph.png" border="0" usemap="#usb__device_8c_9104bea8c7f5045558f6cc5721e7455f_cgraph_map" alt=""></center>
<map name="usb__device_8c_9104bea8c7f5045558f6cc5721e7455f_cgraph_map">
<area shape="rect" href="usb__device_8h.html#cb07fd7b59801b89093d5f5a375a1bb1" title="This function is called when the USB interrupt bit is set In this example the interrupt..." alt="" coords="255,5,476,35"><area shape="rect" href="usb__device_8h.html#42d85f637ff9d3615ca3090303008adc" title="USBClearInterruptFlag" alt="" coords="273,59,457,88"></map>
</div>

</div>
</div><p>
<hr><h2>Documentation des variables</h2>
<a class="anchor" name="98752e9a61499b8a4998c0c3437cf73e"></a><!-- doxytag: member="usb_device.c::controlTransferState" ref="98752e9a61499b8a4998c0c3437cf73e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="el" href="usb__device_8c.html#98752e9a61499b8a4998c0c3437cf73e">controlTransferState</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="8adbb224ae3a638f91eee4cdc5875b2d"></a><!-- doxytag: member="usb_device.c::CtrlTrfData" ref="8adbb224ae3a638f91eee4cdc5875b2d" args="[USB_EP0_BUFF_SIZE]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="el" href="usb__device_8c.html#8adbb224ae3a638f91eee4cdc5875b2d">CtrlTrfData</a>[USB_EP0_BUFF_SIZE]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="faadca393a7d0eb149a153021e5b285b"></a><!-- doxytag: member="usb_device.c::hid_report_in" ref="faadca393a7d0eb149a153021e5b285b" args="[HID_INT_IN_EP_SIZE]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile unsigned char <a class="el" href="usb__device_8c.html#faadca393a7d0eb149a153021e5b285b">hid_report_in</a>[HID_INT_IN_EP_SIZE]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="9505d96e11714db930d011558c1037f9"></a><!-- doxytag: member="usb_device.c::hid_report_out" ref="9505d96e11714db930d011558c1037f9" args="[HID_INT_OUT_EP_SIZE]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile unsigned char <a class="el" href="usb__device_8c.html#9505d96e11714db930d011558c1037f9">hid_report_out</a>[HID_INT_OUT_EP_SIZE]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="f7a9ef2034a293bd6a0f3fae1fac6cf1"></a><!-- doxytag: member="usb_device.c::inPipes" ref="f7a9ef2034a293bd6a0f3fae1fac6cf1" args="[1]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="usb__device_8h.html#c2a1cb280e92f3dd552c9af14a0cbdad">IN_PIPE</a> <a class="el" href="usb__device_8c.html#f7a9ef2034a293bd6a0f3fae1fac6cf1">inPipes</a>[1]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="8b99b9ea7bbb86e5eb28e61ad9c2a833"></a><!-- doxytag: member="usb_device.c::outPipes" ref="8b99b9ea7bbb86e5eb28e61ad9c2a833" args="[1]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="usb__device_8h.html#4ba5b650d99f2b27b570efced4104d57">OUT_PIPE</a> <a class="el" href="usb__device_8c.html#8b99b9ea7bbb86e5eb28e61ad9c2a833">outPipes</a>[1]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="f658a2e95c0119c6701fbab731ba9bd2"></a><!-- doxytag: member="usb_device.c::pBDTEntryEP0OutCurrent" ref="f658a2e95c0119c6701fbab731ba9bd2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile <a class="el" href="union_____b_d_t.html">BDT_ENTRY</a>* <a class="el" href="usb__device_8c.html#f658a2e95c0119c6701fbab731ba9bd2">pBDTEntryEP0OutCurrent</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="f27c82bece5268a38b4f9ef66c31e42f"></a><!-- doxytag: member="usb_device.c::pBDTEntryEP0OutNext" ref="f27c82bece5268a38b4f9ef66c31e42f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile <a class="el" href="union_____b_d_t.html">BDT_ENTRY</a>* <a class="el" href="usb__device_8c.html#f27c82bece5268a38b4f9ef66c31e42f">pBDTEntryEP0OutNext</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="84685e517493b88e709973f8b34b3342"></a><!-- doxytag: member="usb_device.c::pBDTEntryIn" ref="84685e517493b88e709973f8b34b3342" args="[USB_MAX_EP_NUMBER+1]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile <a class="el" href="union_____b_d_t.html">BDT_ENTRY</a>* <a class="el" href="usb__device_8c.html#84685e517493b88e709973f8b34b3342">pBDTEntryIn</a>[USB_MAX_EP_NUMBER+1]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="9777e7690b52368e534894b7c6c2bb18"></a><!-- doxytag: member="usb_device.c::pBDTEntryOut" ref="9777e7690b52368e534894b7c6c2bb18" args="[USB_MAX_EP_NUMBER+1]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile <a class="el" href="union_____b_d_t.html">BDT_ENTRY</a>* <a class="el" href="usb__device_8c.html#9777e7690b52368e534894b7c6c2bb18">pBDTEntryOut</a>[USB_MAX_EP_NUMBER+1]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="f268ebc32589a7de7b47922e44b97a55"></a><!-- doxytag: member="usb_device.c::pDst" ref="f268ebc32589a7de7b47922e44b97a55" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* <a class="el" href="usb__device_8c.html#f268ebc32589a7de7b47922e44b97a55">pDst</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="eada8d244f77e59054a0e399fc5e87cb"></a><!-- doxytag: member="usb_device.c::RemoteWakeup" ref="eada8d244f77e59054a0e399fc5e87cb" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#54d65c7fa62e62c9754371e42f5111b9">BOOL</a> <a class="el" href="usb__device_8c.html#eada8d244f77e59054a0e399fc5e87cb">RemoteWakeup</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="53fb51fd8f590f349a2703af36c04a57"></a><!-- doxytag: member="usb_device.c::SetupPkt" ref="53fb51fd8f590f349a2703af36c04a57" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile <a class="el" href="usb__device_8h.html#15cc7fbb1fa621148405d99bcd66092b">CTRL_TRF_SETUP</a> <a class="el" href="usb__device_8c.html#53fb51fd8f590f349a2703af36c04a57">SetupPkt</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="75b7cb53340c80ab6788fe4dc9ad5d48"></a><!-- doxytag: member="usb_device.c::shortPacketStatus" ref="75b7cb53340c80ab6788fe4dc9ad5d48" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="el" href="usb__device_8c.html#75b7cb53340c80ab6788fe4dc9ad5d48">shortPacketStatus</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="24f71d425c4a6effac1a2d705afe5449"></a><!-- doxytag: member="usb_device.c::USBActiveConfiguration" ref="24f71d425c4a6effac1a2d705afe5449" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="el" href="usb__device_8c.html#24f71d425c4a6effac1a2d705afe5449">USBActiveConfiguration</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="ddb2a0fc77382ce058ef62d88874cf8e"></a><!-- doxytag: member="usb_device.c::USBAlternateInterface" ref="ddb2a0fc77382ce058ef62d88874cf8e" args="[USB_MAX_NUM_INT]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="el" href="usb__device_8c.html#ddb2a0fc77382ce058ef62d88874cf8e">USBAlternateInterface</a>[USB_MAX_NUM_INT]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="86a182d8ae8787e02cfe4c80ad4a612c"></a><!-- doxytag: member="usb_device.c::USBDeviceState" ref="86a182d8ae8787e02cfe4c80ad4a612c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="el" href="usb__device_8c.html#86a182d8ae8787e02cfe4c80ad4a612c">USBDeviceState</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>
INCLUDES. 
<p>
EXTERNS.<p>
VARIABLES 
</div>
</div><p>
<a class="anchor" name="737da50d271f9f7d021abbb7a3a67f6c"></a><!-- doxytag: member="usb_device.c::USBInData" ref="737da50d271f9f7d021abbb7a3a67f6c" args="[USB_MAX_EP_NUMBER]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a>* <a class="el" href="usb__device_8c.html#737da50d271f9f7d021abbb7a3a67f6c">USBInData</a>[USB_MAX_EP_NUMBER]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="77767bab7373fcc3bb2c90b05189e0dd"></a><!-- doxytag: member="usb_device.c::USBInMaxPacketSize" ref="77767bab7373fcc3bb2c90b05189e0dd" args="[USB_MAX_EP_NUMBER]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#2b0e863dadf920709ec53d9088ee7c91">WORD</a> <a class="el" href="usb__device_8c.html#77767bab7373fcc3bb2c90b05189e0dd">USBInMaxPacketSize</a>[USB_MAX_EP_NUMBER]          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
<a class="anchor" name="b75c628c73eaac9e28acbff83a909e63"></a><!-- doxytag: member="usb_device.c::USTATcopy" ref="b75c628c73eaac9e28acbff83a909e63" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_VOLATILE <a class="el" href="_generic_type_defs_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> <a class="el" href="usb__device_8c.html#b75c628c73eaac9e28acbff83a909e63">USTATcopy</a>          </td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>

</div>
</div><p>
</div>
<hr size="1"><address style="text-align: right;"><small>Généré le Sat Feb 14 20:09:27 2009 pour Carte capteurs par&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
